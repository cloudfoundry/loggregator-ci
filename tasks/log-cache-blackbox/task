#!/bin/bash

set -ex

# target api
cf login \
  -a api."$SYSTEM_DOMAIN" \
  -u "$USERNAME" \
  -p "$PASSWORD" \
  -s "$SPACE" \
  -o "$ORG"

GOPATH=$PWD/go

pushd loggregator-tools/log-cache-blackbox
  go get -d ./...
  go build

  cf push "$APP_NAME" -b binary_buildpack -c ./log-cache-blackbox -m 1G --no-start
  cf set-env $APP_NAME LOG_CACHE_ADDR $LOG_CACHE_ADDR
  cf start $APP_NAME
popd

pushd loggregator-tools/experimental/data-dog-accumulator
  go get -d ./...
  go build

  cf push $ACCUMULATOR_APP -b binary_buildpack -c ./data-dog-accumulator -m 1G -u process --no-start

  cf set-env $ACCUMULATOR_APP LOG_CACHE_ADDR $LOG_CACHE_ADDR
  cf set-env $ACCUMULATOR_APP SOURCE_ID $(cf app $APP_NAME --guid)
  cf set-env $ACCUMULATOR_APP DATA_DOG_API_KEY $DATADOG_API_KEY
  cf set-env $ACCUMULATOR_APP HOST $SYSTEM_DOMAIN
  cf set-env $ACCUMULATOR_APP METRIC_PREFIX log_cache

  cf start $ACCUMULATOR_APP
popd

response=$(curl "$APP_DOMAIN" -d='')

latency=$(echo $response | jq .latency)
avg_query_time=$(echo $response | jq .averageQueryTime)

response=$(curl "$APP_DOMAIN/reliability" -d='')

logs_sent=$(echo $response | jq .logsSent)
logs_received=$(echo $response | jq .logsReceived)

currenttime=$(date +%s)
curl --fail -X POST -H "Content-type: application/json" \
-d "{ \"series\" :
  [
    {
      \"metric\":\"log-cache-blackbox.latency\",
      \"points\":[[${currenttime}, ${latency}]],
      \"type\":\"gauge\",
      \"host\":\"${SYSTEM_DOMAIN}\",
      \"tags\":[\"${APP_NAME}\"]
    },
    {
      \"metric\":\"log-cache-blackbox.avg_query_time\",
      \"points\":[[${currenttime}, ${avg_query_time}]],
      \"type\":\"gauge\",
      \"host\":\"${SYSTEM_DOMAIN}\",
      \"tags\":[\"${APP_NAME}\"]
    },
    {
      \"metric\":\"log-cache-blackbox.logs_sent\",
      \"points\":[[${currenttime}, ${logs_sent}]],
      \"type\":\"gauge\",
      \"host\":\"${SYSTEM_DOMAIN}\",
      \"tags\":[\"${APP_NAME}\"]
    },
    {
      \"metric\":\"log-cache-blackbox.logs_received\",
      \"points\":[[${currenttime}, ${logs_received}]],
      \"type\":\"gauge\",
      \"host\":\"${SYSTEM_DOMAIN}\",
      \"tags\":[\"${APP_NAME}\"]
    }
  ]
}" \
'https://app.datadoghq.com/api/v1/series?api_key='"$DATADOG_API_KEY"
