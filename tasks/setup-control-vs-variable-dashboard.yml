platform: linux
image_resource:
  type: docker-image
  source:
    repository: loggregator/base
inputs:
- name: control
- name: variable
params:
  DATADOG_API_KEY:
  DATADOG_APP_KEY:
  CONTROL_SYSTEM_DOMAIN:
  VARIABLE_SYSTEM_DOMAIN:
run:
  path: bash
  args:
  - -c
  - |
    #/bin/bash
    set -ex

    pushd variable
      VARIABLE_SHA=$(git rev-parse HEAD)
    popd

    CONTROL_VERSION=$(cat control/version)

    DASHBOARD_TITLE="Control vs Variable (v$CONTROL_VERSION vs $VARIABLE_SHA)"
    echo $DASHBOARD_TITLE

    cat <<EOF >> /tmp/request-body.json
    {
      "title": "$DASHBOARD_TITLE",
      "description": "$DASHBOARD_TITLE",
      "read_only": "True",
      "graphs" : [
        {
          "title": "Variable Version vs Control Version % Improvement",
          "definition": {
            "viz": "query_value",
            "requests": [
              {
                "q": "( ( avg:regression.smoke_test.loggregator.msg_count{floodspinner,host:api.$VARIABLE_SYSTEM_DOMAIN,loggregator_version:$VARIABLE_SHA} / avg:regression.smoke_test.loggregator.cycles{floodspinner} ) - ( avg:regression.smoke_test.loggregator.msg_count{floodspinner,host:api.$CONTROL_SYSTEM_DOMAIN,loggregator_version:$CONTROL_VERSION} / avg:regression.smoke_test.loggregator.cycles{floodspinner} ) ) * 100",
                "aggregator": "avg",
                "conditional_formats": [
                  {
                    "palette": "white_on_green",
                    "comparator": ">=",
                    "value": "0"
                  },
                  {
                    "palette": "white_on_red",
                    "comparator": "<",
                    "value": "0"
                  }
                ],
                "type": "line"
              }
            ],
            "autoscale": true,
            "markers": [
              {
                "dim": "y",
                "type": "error dashed",
                "val": 0,
                "value": "y = 0",
                "label": "Previous Version Baseline"
              }
            ]
          }
        },
        {
          "title": "Floodspinner Variable and Control",
          "definition": {
            "viz": "timeseries",
            "requests": [
              {
                "q": "avg:regression.smoke_test.loggregator.msg_count{floodspinner,host:api.$VARIABLE_SYSTEM_DOMAIN,loggregator_version:$VARIABLE_SHA}",
                "style": {
                  "palette": "cool",
                  "width": "thin"
                },
                "type": "line",
                "conditional_formats": [],
                "aggregator": "avg"
              },
              {
                "q": "avg:regression.smoke_test.loggregator.msg_count{floodspinner,host:api.$CONTROL_SYSTEM_DOMAIN,loggregator_version:$CONTROL_VERSION}",
                "style": {
                  "palette": "cool",
                  "width": "thin"
                },
                "type": "line"
              }
            ],
            "autoscale": true
          }
        },
        {
          "title": "Variable Version vs Control Version % Improvement",
          "definition": {
            "viz": "timeseries",
            "requests": [
              {
                "q": "( ( avg:regression.smoke_test.loggregator.msg_count{floodspinner,host:api.$VARIABLE_SYSTEM_DOMAIN,loggregator_version:$VARIABLE_SHA} / avg:regression.smoke_test.loggregator.cycles{floodspinner} ) - ( avg:regression.smoke_test.loggregator.msg_count{floodspinner,host:api.$CONTROL_SYSTEM_DOMAIN,loggregator_version:$CONTROL_VERSION} / avg:regression.smoke_test.loggregator.cycles{floodspinner} ) ) * 100",
                "aggregator": "avg",
                "style": {
                  "palette": "cool",
                  "width": "thin"
                },
                "type": "line",
                "conditional_formats": []
              }
            ],
            "autoscale": true,
            "markers": [
              {
                "dim": "y",
                "type": "error dashed",
                "val": 0,
                "value": "y = 0",
                "label": "Previous Version Baseline"
              }
            ]
          }
        }
      ]
    }
    EOF

    curl "https://app.datadoghq.com/api/v1/dash?api_key=${DATADOG_API_KEY}&application_key=${DATADOG_APP_KEY}" -X POST -H "Content-type: application/json" -d "@/tmp/request-body.json"
