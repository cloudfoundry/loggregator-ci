platform: linux
image_resource:
  type: docker-image
  source:
  - repository: loggregator/base
inputs:
- name: scalable-syslog-release
params:
  CF_SYSTEM_DOMAIN:
  CF_USERNAME:
  CF_PASSWORD:
  CF_SPACE:
  CF_ORG:
  CYCLES: 10000
  DELAY_US: 100
  DATADOG_API_KEY:
  DRAIN_VERSION:
  TEARDOWN: true
  JOB_NAME:
run:
  path: bash
  args:
  - -c
  - |
    #!/bin/bash

    set -e

    cd scalable-syslog-release
    export GOPATH=$PWD
    export PATH=$GOPATH/bin:$PATH

    function teardown {
      exit_code=$?
      ./teardown.sh
      exit $exit_code
    }

    function restart {
      exit_code=$?
      ./restart.sh
      exit $exit_code
    }

    function report {
      if [ "$TEARDOWN" = "true" ]; then
        trap teardown EXIT
      else
        trap restart EXIT
      fi

      ./report.sh
    }

    trap report EXIT

    cd src/code.cloudfoundry.org/scalable-syslog/tools/smokes
    ./push.sh
    ./hammer.sh
