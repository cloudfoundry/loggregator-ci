resources:
- name: loggregator-ci
  type: git
  source:
    uri: git@github.com:cloudfoundry/loggregator-ci.git
    private_key: {{loggregator-key}}

- name: service-logs-release-develop
  type: git
  source:
    uri: git@github.com:cloudfoundry/service-logs-release.git
    branch: develop
    private_key: {{cf-loggregator-oauth-bot-key}}
    ignore_paths:
    - .final_builds

- name: service-logs-release-master
  type: git
  source:
    disable_ci_skip: true
    uri: git@github.com:cloudfoundry/service-logs-release.git
    branch: master
    private_key: {{cf-loggregator-oauth-bot-key}}
    clean_tags: true

- name: service-logs-github-release-drafts
  type: github-release
  source:
    user: cloudfoundry
    repository: service-logs-release
    access_token: {{access-token}}
    drafts: true

- name: loggregator-develop
  type: git
  source:
    uri: git@github.com:cloudfoundry/loggregator-release.git
    branch: develop
    private_key: {{loggregator-key}}
    ignore_paths:
    - .final_builds

- name: loggregator-master
  type: git
  source:
    disable_ci_skip: true
    uri: git@github.com:cloudfoundry/loggregator-release.git
    branch: master
    private_key: {{loggregator-key}}
    clean_tags: true

- name: loggregator-backport
  type: git
  source:
    uri: git@github.com:cloudfoundry/loggregator-release.git
    branch: &backport-branch v103.x
    private_key: {{loggregator-key}}

- name: loggregator-release-develop
  type: git
  source:
    uri: git@github.com:cloudfoundry/loggregator-release.git
    branch: develop
    private_key: {{loggregator-key}}
    ignore_paths:
    - .final_builds
    - releases

- name: loggregator-release-master
  type: git
  source:
    uri: git@github.com:cloudfoundry/loggregator-release.git
    branch: master
    private_key: {{loggregator-key}}
    clean_tags: true
    ignore_paths:
    - .final_builds
    - releases

- name: loggregator-release-backport
  type: git
  source:
    uri: git@github.com:cloudfoundry/loggregator-release.git
    branch: *backport-branch
    private_key: {{loggregator-key}}
    ignore_paths:
    - .final_builds
    - releases

- name: loggregator-github-release-drafts
  type: github-release
  source:
    user: cloudfoundry
    repository: loggregator-release
    access_token: {{access-token}}
    drafts: true

- name: cf-syslog-drain-release-develop
  type: git
  source:
    uri: git@github.com:cloudfoundry/cf-syslog-drain-release
    branch: develop
    private_key: {{cf-loggregator-oauth-bot-key}}
    ignore_paths:
    - .final_builds
    - releases

- name: cf-syslog-drain-release-master
  type: git
  source:
    uri: git@github.com:cloudfoundry/cf-syslog-drain-release
    branch: master
    private_key: {{cf-loggregator-oauth-bot-key}}
    clean_tags: true
    ignore_paths:
    - .final_builds
    - releases

- name: cf-syslog-drain-release-backport
  type: git
  source:
    branch: &cf-syslog-backport-branch v7.x
    uri: git@github.com:cloudfoundry/cf-syslog-drain-release
    private_key: {{cf-loggregator-oauth-bot-key}}

- name: cf-syslog-drain-release-github-release-drafts
  type: github-release
  source:
    user: cloudfoundry
    repository: cf-syslog-drain-release
    access_token: {{access-token}}
    drafts: true

- name: service-metrics-release-master
  type: git
  source:
    uri: git@github.com:cloudfoundry/service-metrics-release
    branch: master
    clean_tags: true
    private_key: {{cf-loggregator-oauth-bot-key}}

- name: service-metrics-release-develop
  type: git
  source:
    uri: git@github.com:cloudfoundry/service-metrics-release
    branch: develop
    private_key: {{cf-loggregator-oauth-bot-key}}
    disable_ci_skip: true

- name: service-metrics-release-github-release-drafts
  type: github-release
  source:
    user: cloudfoundry
    repository: service-metrics-release
    access_token: {{access-token}}
    drafts: true

- name: statsd-injector-release-master
  type: git
  source:
    uri: git@github.com:cloudfoundry/statsd-injector-release
    branch: master
    clean_tags: true
    private_key: {{cf-loggregator-oauth-bot-key}}

- name: statsd-injector-release-develop
  type: git
  source:
    uri: git@github.com:cloudfoundry/statsd-injector-release
    branch: develop
    private_key: {{cf-loggregator-oauth-bot-key}}
    disable_ci_skip: true

- name: statsd-injector-release-github-release-drafts
  type: github-release
  source:
    user: cloudfoundry
    repository: statsd-injector-release
    access_token: {{access-token}}
    drafts: true

- name: leadership-election-release-master
  type: git
  source:
    uri: git@github.com:cloudfoundry/leadership-election-release
    branch: master
    clean_tags: true
    private_key: {{cf-loggregator-oauth-bot-key}}

- name: leadership-election-release-develop
  type: git
  source:
    uri: git@github.com:cloudfoundry/leadership-election-release
    branch: develop
    private_key: {{cf-loggregator-oauth-bot-key}}
    disable_ci_skip: true

- name: leadership-election-release-github-release-drafts
  type: github-release
  source:
    user: cloudfoundry
    repository: leadership-election-release
    access_token: {{access-token}}
    drafts: true

- name: reference-nozzle-release
  type: git
  source:
    uri: git@github.com:cloudfoundry-incubator/reference-nozzle-release
    branch: master
    private_key: {{cf-loggregator-oauth-bot-key}}

- name: cf-drain-cli
  type: git
  source:
    uri: git@github.com:cloudfoundry/cf-drain-cli
    branch: master
    private_key: {{cf-loggregator-oauth-bot-key}}

- name: cf-drain-cli-github-release-drafts
  type: github-release
  source:
    user: cloudfoundry
    repository: cf-drain-cli
    access_token: {{access-token}}
    drafts: true

- name: leadership-election-release
  type: git
  source:
    uri: git@github.com:cloudfoundry/leadership-election-release
    branch: develop
    private_key: {{cf-loggregator-oauth-bot-key}}

- name: log-stream-cli
  type: git
  source:
    uri: git@github.com:cloudfoundry/log-stream-cli
    branch: master
    private_key: {{cf-loggregator-oauth-bot-key}}

- name: log-stream-cli-github-release-drafts
  type: github-release
  source:
    user: cloudfoundry
    repository: log-stream-cli
    access_token: {{access-token}}
    drafts: true

- name: loggregator-tools-master
  type: git
  source:
    uri: git@github.com:cloudfoundry-incubator/loggregator-tools
    branch: master
    private_key: {{cf-loggregator-oauth-bot-key}}

- name: noisy-neighbor-nozzle-repo
  type: git
  source:
    uri: git@github.com:cloudfoundry/noisy-neighbor-nozzle
    branch: master
    private_key: {{cf-loggregator-oauth-bot-key}}

- name: noisy-neighbor-release-drafts
  type: github-release
  source:
    user: cloudfoundry
    repository: noisy-neighbor-nozzle
    access_token: {{access-token}}
    drafts: true

- name: logging-acceptance-tests-release
  type: git
  source:
    uri: git@github.com:cloudfoundry/logging-acceptance-tests-release
    branch: master
    private_key: {{cf-loggregator-oauth-bot-key}}

- name: loggregator-agent-release-develop
  type: git
  source:
    uri: git@github.com:cloudfoundry/loggregator-agent-release
    branch: develop
    private_key: {{cf-loggregator-oauth-bot-key}}

- name: loggregator-agent-release-master
  type: git
  source:
    uri: git@github.com:cloudfoundry/loggregator-agent-release
    branch: master
    clean_tags: true
    private_key: {{cf-loggregator-oauth-bot-key}}

- name: loggregator-agent-github-release-drafts
  type: github-release
  source:
    user: cloudfoundry
    repository: loggregator-agent-release
    access_token: {{access-token}}
    drafts: true

jobs:
- name: bump-golang
  serial: true
  plan:
  - aggregate:
    - get: leadership-election-release
    - get: loggregator-ci
    - get: loggregator-develop
    - get: loggregator-agent-release-develop
    - get: logging-acceptance-tests-release
    - get: cf-syslog-drain-release-develop
    - get: statsd-injector-release-develop
    - get: leadership-election-release-develop
    - get: reference-nozzle-release
    - get: service-metrics-release-develop
  - task: download-go
    file: loggregator-ci/tasks/download-golang/task.yml
    params:
      VERSION: &golang-version 1.12.4
  - do:
    - task: leadership-election-release
      file: loggregator-ci/tasks/bump-golang/task.yml
      input_mapping:
        release-repo: leadership-election-release
      output_mapping:
        updated-release-repo: updated-leadership-election-release
      params:
        VERSION: *golang-version
        INCLUDE_WINDOWS: true
        ACCESS_KEY_ID: {{s3-access-key-id}}
        SECRET_ACCESS_KEY: {{s3-secret-access-key}}
        BUCKET_NAME: leadership-election-release-blobs
    - task: commit-leadership-election-release
      file: loggregator-ci/tasks/commit/task.yml
      input_mapping:
        release-repo: updated-leadership-election-release
      output_mapping:
        committed-repo: committed-leadership-election-release
      params:
        COMMIT_MESSAGE: "Bump golang version"
    - put: leadership-election-release
      params:
        repository: committed-leadership-election-release
        rebase: false
  - do:
    - task: bump-loggregator-release
      file: loggregator-ci/tasks/bump-golang/task.yml
      input_mapping:
        release-repo: loggregator-develop
      output_mapping:
        updated-release-repo: updated-loggregator-release
      params:
        VERSION: *golang-version
        INCLUDE_WINDOWS: true
        ACCESS_KEY_ID: {{s3-access-key-id}}
        SECRET_ACCESS_KEY: {{s3-secret-access-key}}
        BUCKET_NAME: loggregator-release-blobs
    - task: commit-loggregator-release
      file: loggregator-ci/tasks/commit/task.yml
      input_mapping:
        release-repo: updated-loggregator-release
      output_mapping:
        committed-repo: committed-loggregator-release
      params:
        COMMIT_MESSAGE: "Bump golang version"
    - put: loggregator-develop
      params:
        repository: committed-loggregator-release
        rebase: false
  - do:
    - task: bump-loggregator-agent-release
      file: loggregator-ci/tasks/bump-golang/task.yml
      input_mapping:
        release-repo: loggregator-agent-release-develop
      output_mapping:
        updated-release-repo: updated-loggregator-agent-release
      params:
        VERSION: *golang-version
        INCLUDE_WINDOWS: true
        ACCESS_KEY_ID: {{s3-access-key-id}}
        SECRET_ACCESS_KEY: {{s3-secret-access-key}}
        BUCKET_NAME: loggregator-agent-release-blobs
    - task: commit-loggregator-agent-release
      file: loggregator-ci/tasks/commit/task.yml
      input_mapping:
        release-repo: updated-loggregator-agent-release
      output_mapping:
        committed-repo: committed-loggregator-agent-release
      params:
        COMMIT_MESSAGE: "Bump golang version"
    - put: loggregator-agent-release-develop
      params:
        repository: committed-loggregator-agent-release
        rebase: false
  - do:
    - task: bump-cf-syslog-drain-release
      file: loggregator-ci/tasks/bump-golang/task.yml
      input_mapping:
        release-repo: cf-syslog-drain-release-develop
      output_mapping:
        updated-release-repo: updated-cf-syslog-drain-release
      params:
        VERSION: *golang-version
        ACCESS_KEY_ID: {{s3-access-key-id}}
        SECRET_ACCESS_KEY: {{s3-secret-access-key}}
        BUCKET_NAME: cf-syslog-drain-release-blobs
    - task: commit-cf-syslog-drain-release
      file: loggregator-ci/tasks/commit/task.yml
      input_mapping:
        release-repo: updated-cf-syslog-drain-release
      output_mapping:
        committed-repo: committed-cf-syslog-drain-release
      params:
        COMMIT_MESSAGE: "Bump golang version"
    - put: cf-syslog-drain-release-develop
      params:
        repository: committed-cf-syslog-drain-release
        rebase: false
  - do:
    - task: bump-statsd-injector-release
      file: loggregator-ci/tasks/bump-golang/task.yml
      input_mapping:
        release-repo: statsd-injector-release-develop
      output_mapping:
        updated-release-repo: updated-statsd-injector-release
      params:
        VERSION: *golang-version
        ACCESS_KEY_ID: {{s3-access-key-id}}
        SECRET_ACCESS_KEY: {{s3-secret-access-key}}
        BUCKET_NAME: statsd-injector-release-blobs
    - task: commit-statsd-injector-release
      file: loggregator-ci/tasks/commit/task.yml
      input_mapping:
        release-repo: updated-statsd-injector-release
      output_mapping:
        committed-repo: committed-statsd-injector-release
      params:
        COMMIT_MESSAGE: "Bump golang version"
    - put: statsd-injector-release-develop
      params:
        repository: committed-statsd-injector-release
        rebase: false
  - do:
    - task: bump-leadership-election-release
      file: loggregator-ci/tasks/bump-golang/task.yml
      input_mapping:
        release-repo: leadership-election-release-develop
      output_mapping:
        updated-release-repo: updated-leadership-election-release
      params:
        VERSION: *golang-version
        ACCESS_KEY_ID: {{s3-access-key-id}}
        SECRET_ACCESS_KEY: {{s3-secret-access-key}}
        BUCKET_NAME: leadership-election-release-blobs
    - task: commit-leadership-election-release
      file: loggregator-ci/tasks/commit/task.yml
      input_mapping:
        release-repo: updated-leadership-election-release
      output_mapping:
        committed-repo: committed-leadership-election-release
      params:
        COMMIT_MESSAGE: "Bump golang version"
    - put: leadership-election-release-develop
      params:
        repository: committed-leadership-election-release
        rebase: false
  - do:
    - task: bump-reference-nozzle-release
      file: loggregator-ci/tasks/bump-golang/task.yml
      input_mapping:
        release-repo: reference-nozzle-release
      output_mapping:
        updated-release-repo: updated-reference-nozzle-release
      params:
        VERSION: *golang-version
        ACCESS_KEY_ID: {{s3-access-key-id}}
        SECRET_ACCESS_KEY: {{s3-secret-access-key}}
        BUCKET_NAME: reference-nozzle-release-blobs
    - task: commit-reference-nozzle-release
      file: loggregator-ci/tasks/commit/task.yml
      input_mapping:
        release-repo: updated-reference-nozzle-release
      output_mapping:
        committed-repo: committed-reference-nozzle-release
      params:
        COMMIT_MESSAGE: "Bump golang version"
    - put: reference-nozzle-release
      params:
        repository: committed-reference-nozzle-release
        rebase: false
  - do:
    - task: bump-logging-acceptance-tests-release
      file: loggregator-ci/tasks/bump-golang/task.yml
      input_mapping:
        release-repo: logging-acceptance-tests-release
      output_mapping:
        updated-release-repo: updated-logging-acceptance-tests-release
      params:
        VERSION: *golang-version
        ACCESS_KEY_ID: {{s3-access-key-id}}
        SECRET_ACCESS_KEY: {{s3-secret-access-key}}
        BUCKET_NAME: logging-acceptance-tests-blobs
    - task: commit-logging-acceptance-tests-release
      file: loggregator-ci/tasks/commit/task.yml
      input_mapping:
        release-repo: updated-logging-acceptance-tests-release
      output_mapping:
        committed-repo: committed-logging-acceptance-tests-release
      params:
        COMMIT_MESSAGE: "Bump golang version"
    - put: logging-acceptance-tests-release
      params:
        repository: committed-logging-acceptance-tests-release
        rebase: false
  - do:
    - task: bump-service-metrics-release
      file: loggregator-ci/tasks/bump-golang/task.yml
      input_mapping:
        release-repo: service-metrics-release-develop
      output_mapping:
        updated-release-repo: updated-service-metrics-release
      params:
        VERSION: *golang-version
        ACCESS_KEY_ID: {{loggregator-team-s3-access-key}}
        SECRET_ACCESS_KEY: {{loggregator-team-s3-secret-key}}
        BUCKET_NAME: oss-service-metrics-release-blobs
    - task: commit-service-metrics-release
      file: loggregator-ci/tasks/commit/task.yml
      input_mapping:
        release-repo: updated-service-metrics-release
      output_mapping:
        committed-repo: committed-service-metrics-release
      params:
        COMMIT_MESSAGE: "Bump golang version"
    - put: service-metrics-release-develop
      params:
        repository: committed-service-metrics-release
        rebase: false

- name: loggregator-create-release
  serial: true
  plan:
  - aggregate:
    - get: loggregator-develop
    - get: loggregator-master
      resource: loggregator-master
    - get: loggregator-ci
  - task: create-final-release
    file: loggregator-ci/tasks/create-final-release/task.yml
    input_mapping:
      master-repo: loggregator-master
      develop-repo: loggregator-develop
    params:
      S3_ACCESS_KEY: {{loggregator-team-s3-access-key}}
      S3_SECRET_KEY: {{loggregator-team-s3-secret-key}}
      BLOBSTORE_BUCKET: loggregator-release-blobs
      SSH_KEY: {{loggregator-key}}
      MAJOR_VERSION: "1"
      RELEASE_NAME: Loggregator
      DEVELOP_BRANCH: develop
      MASTER_BRANCH: master
  - put: loggregator-release-master
    params:
      repository: repos/master-repo
      rebase: false
  - put: loggregator-release-develop
    params:
      repository: repos/develop-repo
      rebase: false
  - put: loggregator-github-release-drafts
    params:
      name: github-release/name
      tag: github-release/tag
      body: github-release/body
      globs:
      - github-release/*.tgz

- name: loggregator-create-backport-release
  serial: true
  plan:
  - get: loggregator-backport
  - task: create-backport
    file: loggregator-ci/tasks/backport/loggregator/task.yml
    params:
      S3_ACCESS_KEY: {{loggregator-team-s3-access-key}}
      S3_SECRET_KEY: {{loggregator-team-s3-secret-key}}
      SSH_KEY: {{loggregator-key}}
      MAJOR_VERSION: "1"
      BRANCH_NAME: *backport-branch
  - put: loggregator-release-backport
    params:
      repository: create-final-release/loggregator-backport
      rebase: false
  - put: loggregator-github-release-drafts
    params:
      name: github-release/name
      tag: github-release/tag
      body: github-release/body
      globs:
      - github-release/*.tgz

- name: cf-syslog-drain-create-final-release
  serial: true
  plan:
  - aggregate:
    - get: cf-syslog-drain-release-develop
    - get: cf-syslog-drain-release-master
    - get: loggregator-ci
  - task: create-final-release
    file: loggregator-ci/tasks/create-final-release/task.yml
    input_mapping:
      master-repo: cf-syslog-drain-release-master
      develop-repo: cf-syslog-drain-release-develop
    params:
      S3_ACCESS_KEY: {{s3-access-key-id}}
      S3_SECRET_KEY: {{s3-secret-access-key}}
      BLOBSTORE_BUCKET: cf-syslog-drain-release-blobs
      SSH_KEY: {{loggregator-key}}
      MAJOR_VERSION: "1"
      RELEASE_NAME: "CF Syslog Drain Release"
      DEVELOP_BRANCH: develop
      MASTER_BRANCH: master
  - put: cf-syslog-drain-release-master
    params:
      repository: repos/master-repo
      rebase: false
  - put: cf-syslog-drain-release-develop
    params:
      repository: repos/develop-repo
      rebase: false
  - put: cf-syslog-drain-release-github-release-drafts
    params:
      name: github-release/name
      tag: github-release/tag
      body: github-release/body
      globs:
      - github-release/*.tgz

- name: cf-syslog-release-create-backport
  serial: true
  plan:
  - get: cf-syslog-drain-release-backport
    trigger: false
  - task: create-backport
    file: loggregator-ci/tasks/backport/syslog/task.yml
    params:
      S3_ACCESS_KEY: {{s3-access-key-id}}
      S3_SECRET_KEY: {{s3-secret-access-key}}
      SSH_KEY: {{loggregator-key}}
      BLOBSTORE_BUCKET: cf-syslog-drain-release-blobs
      MAJOR_VERSION: "7"
      BRANCH_NAME: *cf-syslog-backport-branch
  - put: cf-syslog-drain-release-backport
    params:
      repository: create-final-release/cf-syslog-drain-release-backport
      rebase: false
  - put: cf-syslog-drain-release-github-release-drafts
    params:
      name: github-release/name
      tag: github-release/tag
      body: github-release/body
      globs:
      - github-release/*.tgz

- name: service-metrics-create-final-release
  serial: true
  plan:
  - aggregate:
    - get: service-metrics-release-develop
    - get: service-metrics-release-master
    - get: loggregator-ci
  - task: create-final-release
    file: loggregator-ci/tasks/create-final-release/task.yml
    input_mapping:
      master-repo: service-metrics-release-master
      develop-repo: service-metrics-release-develop
    params:
      S3_ACCESS_KEY: {{loggregator-team-s3-access-key}}
      S3_SECRET_KEY: {{loggregator-team-s3-secret-key}}
      BLOBSTORE_BUCKET: oss-service-metrics-release-blobs
      SSH_KEY: {{loggregator-key}}
      MAJOR_VERSION: 1.0
      RELEASE_NAME: service-metrics-release
      DEVELOP_BRANCH: develop
      MASTER_BRANCH: master
  - put: service-metrics-release-master
    params:
      repository: repos/master-repo
      rebase: false
  - put: service-metrics-release-develop
    params:
      repository: repos/develop-repo
      rebase: false
  - put: service-metrics-release-github-release-drafts
    params:
      name: github-release/name
      tag: github-release/tag
      body: github-release/body
      globs:
      - github-release/*.tgz

- name: statsd-injector-create-final-release
  serial: true
  plan:
  - aggregate:
    - get: statsd-injector-release-develop
    - get: statsd-injector-release-master
    - get: loggregator-ci
  - task: create-final-release
    file: loggregator-ci/tasks/create-final-release/task.yml
    input_mapping:
      master-repo: statsd-injector-release-master
      develop-repo: statsd-injector-release-develop
    params:
      S3_ACCESS_KEY: {{s3-access-key-id}}
      S3_SECRET_KEY: {{s3-secret-access-key}}
      BLOBSTORE_BUCKET: statsd-injector-release-blobs
      SSH_KEY: {{loggregator-key}}
      MAJOR_VERSION: "1"
      RELEASE_NAME: statsd-injector-release
      DEVELOP_BRANCH: develop
      MASTER_BRANCH: master
  - put: statsd-injector-release-master
    params:
      repository: repos/master-repo
      rebase: false
  - put: statsd-injector-release-develop
    params:
      repository: repos/develop-repo
      rebase: false
  - put: statsd-injector-release-github-release-drafts
    params:
      name: github-release/name
      tag: github-release/tag
      body: github-release/body
      globs:
      - github-release/*.tgz

- name: leadership-election-create-final-release
  serial: true
  plan:
  - aggregate:
    - get: leadership-election-release-develop
    - get: leadership-election-release-master
    - get: loggregator-ci
  - task: create-final-release
    file: loggregator-ci/tasks/create-final-release/task.yml
    input_mapping:
      master-repo: leadership-election-release-master
      develop-repo: leadership-election-release-develop
    params:
      S3_ACCESS_KEY: {{s3-access-key-id}}
      S3_SECRET_KEY: {{s3-secret-access-key}}
      BLOBSTORE_BUCKET: leadership-election-release-blobs
      SSH_KEY: {{loggregator-key}}
      MAJOR_VERSION: "1"
      RELEASE_NAME: leadership-election-release
      DEVELOP_BRANCH: develop
      MASTER_BRANCH: master
  - put: leadership-election-release-master
    params:
      repository: repos/master-repo
      rebase: false
  - put: leadership-election-release-develop
    params:
      repository: repos/develop-repo
      rebase: false
  - put: leadership-election-release-github-release-drafts
    params:
      name: github-release/name
      tag: github-release/tag
      body: github-release/body
      globs:
      - github-release/*.tgz

- name: cf-drain-cli
  serial: true
  plan:
  - aggregate:
    - get: loggregator-ci
    - get: cf-drain-cli
    - get: loggregator-tools-master
  - task: create-binaries
    file: loggregator-ci/tasks/release-cf-drain-cli/task.yml
    params:
      VERSION_MAJOR: 1
      VERSION_MINOR: 2
    input_mapping:
      loggregator-tools: loggregator-tools-master
  - put: cf-drain-cli
    params:
      repository: output-repo/cf-drain-cli
      rebase: false
  - put: cf-drain-cli-github-release-drafts
    params:
      name: github-release/name
      tag: github-release/tag
      body: github-release/body
      globs:
      - github-release/builds/*

- name: log-stream-cli
  serial: true
  plan:
  - aggregate:
    - get: loggregator-ci
    - get: log-stream-cli
  - task: create-binaries
    file: loggregator-ci/tasks/release-log-stream-cli/task.yml
    params:
      VERSION_MAJOR: 0
      VERSION_MINOR: 3
  - put: log-stream-cli
    params:
      repository: output-repo/log-stream-cli
      rebase: false
  - put: log-stream-cli-github-release-drafts
    params:
      name: github-release/name
      tag: github-release/tag
      body: github-release/body
      globs:
      - github-release/builds/*

- name: noisy-neighbor-binaries
  serial: true
  plan:
  - aggregate:
    - get: noisy-neighbor-nozzle-repo
  - task: create-binaries
    file: loggregator-ci/tasks/noisy-neighbor-create-binaries/task.yml
    params:
      VERSION_MAJOR: 1
      VERSION_MINOR: 5
      VERSION_PATCH: 1
  - put: noisy-neighbor-nozzle-repo
    params:
      repository: repo-output
      rebase: false
      tag: github-release/tag
  - put: noisy-neighbor-release-drafts
    params:
      name: github-release/name
      tag: github-release/tag
      body: github-release/body
      globs:
      - binary-output/*

- name: loggregator-agent-create-final-release
  serial: true
  plan:
  - aggregate:
    - get: loggregator-agent-release-develop
    - get: loggregator-agent-release-master
    - get: loggregator-ci
  - task: create-final-release
    file: loggregator-ci/tasks/create-final-release/task.yml
    input_mapping:
      master-repo: loggregator-agent-release-master
      develop-repo: loggregator-agent-release-develop
    params:
      S3_ACCESS_KEY: {{loggregator-team-s3-access-key}}
      S3_SECRET_KEY: {{loggregator-team-s3-secret-key}}
      BLOBSTORE_BUCKET: loggregator-agent-release-blobs
      SSH_KEY: {{loggregator-key}}
      MAJOR_VERSION: "3"
      RELEASE_NAME: "Loggregator Agent"
      DEVELOP_BRANCH: develop
      MASTER_BRANCH: master
  - put: loggregator-agent-release-master
    params:
      repository: repos/master-repo
      rebase: false
  - put: loggregator-agent-release-develop
    params:
      repository: repos/develop-repo
      rebase: false
  - put: loggregator-agent-github-release-drafts
    params:
      name: github-release/name
      tag: github-release/tag
      body: github-release/body
      globs:
      - github-release/*.tgz

- name: service-logs-release-create-release
  serial: true
  plan:
  - aggregate:
    - get: service-logs-release-develop
    - get: service-logs-release-master
      resource: service-logs-release-master
    - get: loggregator-ci
  - task: create-final-release
    file: loggregator-ci/tasks/create-final-release/task.yml
    input_mapping:
      master-repo: service-logs-release-master
      develop-repo: service-logs-release-develop
    params:
      S3_ACCESS_KEY: {{loggregator-team-s3-access-key}}
      S3_SECRET_KEY: {{loggregator-team-s3-secret-key}}
      BLOBSTORE_BUCKET: service-logs-release-blobs
      SSH_KEY: {{loggregator-key}}
      MAJOR_VERSION: "1"
      RELEASE_NAME: "Service Logs"
      DEVELOP_BRANCH: develop
      MASTER_BRANCH: master
  - put: service-logs-release-master
    params:
      repository: repos/master-repo
      rebase: false
  - put: service-logs-release-develop
    params:
      repository: repos/develop-repo
      rebase: false
  - put: service-logs-github-release-drafts
    params:
      name: github-release/name
      tag: github-release/tag
      body: github-release/body
      globs:
      - github-release/*.tgz
