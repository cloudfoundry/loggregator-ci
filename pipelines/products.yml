groups:
- name: all
  jobs:
  - cf-deploy
  - cfar-lats
  - cats
  - noisy-neighbor-nozzle-tests
  - noisy-neighbor-nozzle-deploy
  - service-metrics-tests
  - service-metrics-deploy
  - service-metrics-smoke-tests
  - service-metrics-promotion
  - service-metrics-master-promotion

  - statsd-injector-tests
  - statsd-injector-promotion
  - statsd-injector-master-promotion

  - loggregator-agent-master-promotion
  - loggregator-agent-tests
  - loggregator-master-promotion
  - loggregator-agent-promotion
  - loggregator-tests
  - loggregator-promotion

  - cf-syslog-drain-tests
  - cf-syslog-drain-master-promotion
  - cf-syslog-drain-promotion
  - cf-drain-cli-tests
  - cf-drain-cli-promotion

  - log-stream-cli-tests
  - log-stream-cli-promotion

  - leadership-election-tests
  - leadership-election-promotion
  - leadership-election-master-promotion

  - service-logs-unit-tests
  - service-logs-deploy
  - service-logs-smoke-test
  - service-logs-promotion
  - service-logs-master-promotion
  - test-releases-can-be-exported

- name: cf-syslog-drain
  jobs:
  - cf-syslog-drain-tests
  - cf-drain-cli-tests
  - cf-deploy
  - cats
  - cfar-lats
  - test-releases-can-be-exported
  - cf-syslog-drain-promotion
  - cf-syslog-drain-master-promotion
  - cf-drain-cli-promotion

- name: log-stream-cli
  jobs:
  - log-stream-cli-tests
  - cfar-lats
  - log-stream-cli-promotion

- name: loggregator
  jobs:
  - loggregator-tests
  - cf-deploy
  - cfar-lats
  - cats
  - test-releases-can-be-exported
  - loggregator-promotion
  - loggregator-master-promotion

- name: agent
  jobs:
  - loggregator-agent-tests
  - cf-deploy
  - cfar-lats
  - cats
  - test-releases-can-be-exported
  - loggregator-agent-promotion
  - loggregator-agent-master-promotion

- name: statsd-injector
  jobs:
  - statsd-injector-tests
  - cf-deploy
  - cats
  - cfar-lats
  - test-releases-can-be-exported
  - statsd-injector-promotion
  - statsd-injector-master-promotion

- name: noisy-neighbor
  jobs:
  - noisy-neighbor-nozzle-tests
  - noisy-neighbor-nozzle-deploy

- name: service-metrics
  jobs:
  - service-metrics-tests
  - service-metrics-deploy
  - service-metrics-smoke-tests
  - test-releases-can-be-exported
  - service-metrics-promotion
  - service-metrics-master-promotion

- name: leadership-election
  jobs:
  - leadership-election-tests
  - cf-deploy
  - cfar-lats
  - cats
  - test-releases-can-be-exported
  - leadership-election-promotion
  - leadership-election-master-promotion

- name: service-logs
  jobs:
  - service-logs-unit-tests
  - service-logs-deploy
  - service-logs-smoke-test
  - test-releases-can-be-exported
  - service-logs-promotion
  - service-logs-master-promotion

resources:
- name: 5m
  type: time
  source:
    interval: 5m

- name: 24h
  type: time
  source:
    interval: 24h

- name: cf-acceptance-tests
  type: git
  source:
    branch: master
    uri: https://github.com/cloudfoundry/cf-acceptance-tests.git

- name: cf-deployment
  type: git
  source:
    uri: https://github.com/cloudfoundry/cf-deployment
    tag_filter: v*
    private_key: ((loggregator-key))

- name: cf-deployment-concourse-tasks
  type: git
  source:
    uri: https://github.com/cloudfoundry/cf-deployment-concourse-tasks
    tag_filter: v*

- name: concourse-tasks
  type: git
  source:
    branch: master
    uri: https://github.com/pivotal-cf/concourse-tasks

- name: cf-drain-cli
  type: git
  source:
    uri: https://github.com/cloudfoundry/cf-drain-cli
    branch: develop

- name: cf-drain-cli-master
  type: git
  source:
    uri: git@github.com:cloudfoundry/cf-drain-cli
    branch: master
    private_key: ((cf-loggregator-oauth-bot-key))

- name: cf-syslog-drain-release
  type: git
  source:
    uri: git@github.com:cloudfoundry/cf-syslog-drain-release
    branch: develop
    private_key: ((cf-loggregator-oauth-bot-key))
    ignore_paths:
    - .final_builds
    - releases

- name: cf-syslog-drain-release-master
  type: git
  source:
    uri: git@github.com:cloudfoundry/cf-syslog-drain-release
    branch: master
    private_key: ((cf-loggregator-oauth-bot-key))
    disable_ci_skip: true

- name: cf-syslog-drain-release-release-elect
  type: git
  source:
    uri: git@github.com:cloudfoundry/cf-syslog-drain-release
    branch: release-elect
    private_key: ((cf-loggregator-oauth-bot-key))
    ignore_paths:
    - .final_builds
    - releases

- name: cfar-logging-acceptance-tests
  type: git
  source:
    branch: master
    uri: https://github.com/cloudfoundry/cfar-logging-acceptance-tests.git

- name: deployments-loggregator
  type: git
  source:
    uri: git@github.com:cloudfoundry/deployments-loggregator.git
    branch: master
    private_key: {{deployments-loggregator-key}}

- name: denver-deployments
  type: git
  source:
    uri: git@github.com:pivotal-cf/denver-deployments.git
    branch: master
    private_key: {{cf-loggregator-oauth-bot-key}}

- name: log-stream-cli
  type: git
  source:
    uri: https://github.com/cloudfoundry/log-stream-cli
    branch: develop

- name: log-stream-cli-master
  type: git
  source:
    uri: git@github.com:cloudfoundry/log-stream-cli
    branch: master
    private_key: ((cf-loggregator-oauth-bot-key))

- name: loggregator-agent-release
  type: git
  source:
    uri: git@github.com:cloudfoundry/loggregator-agent-release.git
    branch: develop
    private_key: {{cf-loggregator-oauth-bot-key}}

- name: loggregator-agent-release-elect
  type: git
  source:
    uri: git@github.com:cloudfoundry/loggregator-agent-release.git
    branch: release-elect
    private_key: ((cf-loggregator-oauth-bot-key))

- name: loggregator-agent-release-master
  type: git
  source:
    uri: git@github.com:cloudfoundry/loggregator-agent-release.git
    branch: master

    private_key: ((cf-loggregator-oauth-bot-key))
    disable_ci_skip: true

- name: loggregator-ci
  type: git
  source:
    uri: git@github.com:cloudfoundry/loggregator-ci
    branch: master
    private_key: {{cf-loggregator-oauth-bot-key}}

- name: loggregator-release-release-elect
  type: git
  source:
    uri: git@github.com:cloudfoundry/loggregator-release.git
    branch: release-elect
    private_key: {{loggregator-key}}
    ignore_paths:
    - .final_builds
    - releases

- name: loggregator-release
  type: git
  source:
    uri: git@github.com:cloudfoundry/loggregator-release.git
    branch: develop
    private_key: ((loggregator-key))
    ignore_paths:
    - .final_builds
    - releases

- name: loggregator-release-master
  type: git
  source:
    uri: git@github.com:cloudfoundry/loggregator-release.git
    branch: master
    private_key: ((loggregator-key))
    disable_ci_skip: true

- name: noisy-neighbor-nozzle
  type: git
  source:
    uri: https://github.com/cloudfoundry/noisy-neighbor-nozzle

- name: service-metrics-release
  type: git
  source:
    uri: git@github.com:cloudfoundry/service-metrics-release
    branch: develop
    private_key: {{cf-loggregator-oauth-bot-key}}

- name: service-metrics-release-master
  type: git
  source:
    uri: git@github.com:cloudfoundry/service-metrics-release
    branch: master
    private_key: {{cf-loggregator-oauth-bot-key}}
    disable_ci_skip: true

- name: service-metrics-release-release-elect
  type: git
  source:
    uri: git@github.com:cloudfoundry/service-metrics-release
    branch: release-elect
    private_key: {{cf-loggregator-oauth-bot-key}}
    ignore_paths:
    - .final_builds
    - releases

- name: statsd-injector-release
  type: git
  source:
    uri: git@github.com:cloudfoundry/statsd-injector-release
    branch: develop
    private_key: {{cf-loggregator-oauth-bot-key}}
    ignore_paths:
    - .final_builds
    - releases

- name: statsd-injector-release-release-elect
  type: git
  source:
    uri: git@github.com:cloudfoundry/statsd-injector-release.git
    branch: release-elect
    private_key: {{cf-loggregator-oauth-bot-key}}
    ignore_paths:
    - .final_builds
    - releases

- name: statsd-injector-release-master
  type: git
  source:
    uri: git@github.com:cloudfoundry/statsd-injector-release.git
    branch: master
    private_key: ((cf-loggregator-oauth-bot-key))
    disable_ci_skip: true

- name: leadership-election-release
  type: git
  source:
    uri: git@github.com:cloudfoundry/leadership-election-release
    branch: develop
    private_key: {{cf-loggregator-oauth-bot-key}}
    ignore_paths:
    - .final_builds
    - releases

- name: leadership-election-release-release-elect
  type: git
  source:
    uri: git@github.com:cloudfoundry/leadership-election-release.git
    branch: release-elect
    private_key: {{cf-loggregator-oauth-bot-key}}
    ignore_paths:
    - .final_builds
    - releases

- name: leadership-election-release-master
  type: git
  source:
    uri: git@github.com:cloudfoundry/leadership-election-release.git
    branch: master
    private_key: ((cf-loggregator-oauth-bot-key))
    disable_ci_skip: true

- name: service-logs-release
  type: git
  source:
    uri: git@github.com:cloudfoundry/service-logs-release
    branch: develop
    private_key: {{cf-loggregator-oauth-bot-key}}
    ignore_paths:
    - .final_builds
    - releases

- name: service-logs-release-release-elect
  type: git
  source:
    uri: git@github.com:cloudfoundry/service-logs-release.git
    branch: release-elect
    private_key: {{cf-loggregator-oauth-bot-key}}
    ignore_paths:
    - .final_builds
    - releases

- name: service-logs-release-master
  type: git
  source:
    uri: git@github.com:cloudfoundry/service-logs-release.git
    branch: master
    private_key: ((cf-loggregator-oauth-bot-key))
    disable_ci_skip: true

- name: gopsutil
  type: git
  source:
    uri: https://github.com/shirou/gopsutil
    branch: master
    tag_filter: v2.19.04

jobs:
###############################################################################
# LOG STREAM CLI
###############################################################################

- name: log-stream-cli-tests
  serial: true
  public: true
  plan:
  - aggregate:
    - get: loggregator-ci
    - get: log-stream-cli
      trigger: true
  - task: run-tests
    file: loggregator-ci/tasks/go-test-with-latest-packages/task.yml
    input_mapping:
      source-repo: log-stream-cli
    params:
      IMPORT_PATH: github.com/cloudfoundry/log-stream-cli

- name: log-stream-cli-promotion
  serial: true
  plan:
  - get: 5m
    trigger: true
  - aggregate:
    - get: log-stream-cli
      passed: ["cfar-lats"]
      trigger: true
    - get: log-stream-cli-master
    - get: loggregator-ci
  - task: bumper
    file: loggregator-ci/tasks/bumper/task.yml
    input_mapping:
      source: log-stream-cli
      dest: log-stream-cli-master
    params:
      SOURCE_BRANCH: develop
      DEST_BRANCH: master
  - put: log-stream-cli-master
    params:
      repository: merged-dest

###############################################################################
# LOGGREGATOR
###############################################################################
- name: loggregator-tests
  serial: true
  public: true
  plan:
  - aggregate:
    - get: loggregator-ci
    - get: 24h
      trigger: true
    - get: loggregator-release
      trigger: true
  - task: run-tests
    file: loggregator-ci/tasks/go-bump-modules-and-test/task.yml
    input_mapping:
      source-repo: loggregator-release
  - task: commit
    file: loggregator-ci/tasks/commit/task.yml
    input_mapping:
      release-repo: bumped-source
    output_mapping:
      committed-repo: committed-loggregator-release
    params:
      COMMIT_MESSAGE: "Bump modules"
  - put: loggregator-release
    params:
      repository: committed-loggregator-release
      rebase: false

- name: loggregator-agent-tests
  serial: true
  public: true
  plan:
  - aggregate:
    - get: loggregator-ci
    - get: loggregator-agent-release
      trigger: true
    - get: gopsutil
  - aggregate:
    - task: run-tests
      file: loggregator-ci/tasks/go-bump-modules-and-test/task.yml
      input_mapping:
        source-repo: loggregator-agent-release
    - do:
      - task: build-windows-test-binary
        config:
          platform: linux
          image_resource:
            type: docker-image
            source:
              repository: loggregator/base
          inputs:
          - name: loggregator-agent-release
          - name: gopsutil
            path: workspace/src/github.com/shirou/gopsutil
          outputs:
          - name: binaries
          - name: test-binaries
          run:
            path: bash
            args:
            - -c
            - |
              #!/bin/bash
              set -ex

              ci_root=$PWD
              function munge {
                echo $1 | tr '/' '_'
              }

              export GOOS=windows
              export PATH="$GOPATH/bin:$PATH"
              export GO111MODULE=on

              pushd loggregator-agent-release/src
                go get -u ./...
                go mod tidy
                go mod vendor

                pushd src/cmd
                  for pkg in $(go list ./... | grep -vE metric-scraper\|syslog-binding-cache\|udp-forwarder); do
                    go test -mod=vendor -c -o $ci_root/test-binaries/$(munge $pkg)_test.exe $pkg &
                  done
                popd
              popd
              wait
      - task: run-windows-tests
        config:
          platform: windows
          inputs:
          - name: binaries
          - name: test-binaries
          run:
            path: powershell
            args:
            - "-command"
            - |
              trap {
                write-error $_
                exit 1
              }

              $env:SKIP_BUILD = "true"

              # Run all test binaries
              Get-ChildItem -Filter test-binaries\*.exe | ForEach {
                &$_.Fullname /s
                if ($LastExitCode -ne 0) {
                  throw "test failed"
                }
              }
  - task: commit
    file: loggregator-ci/tasks/commit/task.yml
    input_mapping:
      release-repo: bumped-source
    output_mapping:
      committed-repo: committed-loggregator-agent-release
    params:
      COMMIT_MESSAGE: "Bump modules"
  - put: loggregator-agent-release
    params:
      repository: committed-loggregator-agent-release
      rebase: false

- name: loggregator-promotion
  serial: true
  plan:
  - aggregate:
    - get: develop
      resource: loggregator-release
      trigger: true
      passed: ["cats", "cfar-lats", "test-releases-can-be-exported"]
    - get: loggregator-release-release-elect
  - put: loggregator-release-release-elect
    params:
      repository: develop

- name: loggregator-agent-promotion
  serial: true
  plan:
  - aggregate:
    - get: develop
      resource: loggregator-agent-release
      trigger: true
      passed: ["cats", "cfar-lats", "test-releases-can-be-exported"]
    - get: loggregator-agent-release-elect
  - put: loggregator-agent-release-elect
    params:
      repository: develop

- name: loggregator-master-promotion
  serial: true
  plan:
  - aggregate:
    - get: 5m
      trigger: true
    - get: loggregator-release-release-elect
      passed: ["loggregator-promotion"]
      trigger: true
    - get: loggregator-agent-release-elect
      passed: ["loggregator-agent-promotion"]
      trigger: true
    - get: loggregator-release-master
    - get: loggregator-ci
  - task: bumper
    file: loggregator-ci/tasks/bumper/task.yml
    input_mapping:
      source: loggregator-release-release-elect
      dest: loggregator-release-master
    params:
      SOURCE_BRANCH: release-elect
      DEST_BRANCH: master
      FOLLOW_BUMPS_OF: src/code.cloudfoundry.org/loggregator,src/code.cloudfoundry.org/go-loggregator,src/code.cloudfoundry.org/loggregator-agent
  - put: loggregator-release-master
    params:
      repository: merged-dest

- name: loggregator-agent-master-promotion
  serial: true
  plan:
  - aggregate:
    - get: 5m
      trigger: true
    - get: loggregator-agent-release-elect
      passed: ["loggregator-agent-promotion"]
      trigger: true
    - get: loggregator-agent-release-master
    - get: loggregator-ci
  - task: bumper
    file: loggregator-ci/tasks/bumper/task.yml
    input_mapping:
      source: loggregator-agent-release-elect
      dest: loggregator-agent-release-master
    params:
      SOURCE_BRANCH: release-elect
      DEST_BRANCH: master
      FOLLOW_BUMPS_OF: src/code.cloudfoundry.org/go-loggregator,src/code.cloudfoundry.org/loggregator-agent
  - put: loggregator-agent-release-master
    params:
      repository: merged-dest

###############################################################################
# CF SYSLOG DRAIN
###############################################################################
- name: cf-syslog-drain-tests
  serial: true
  public: true
  plan:
  - aggregate:
    - get: loggregator-ci
    - get: 24h
      trigger: true
    - get: cf-syslog-drain-release
      trigger: true
  - task: run-tests
    file: loggregator-ci/tasks/go-bump-modules-and-test/task.yml
    input_mapping:
      source-repo: cf-syslog-drain-release
  - task: commit
    file: loggregator-ci/tasks/commit/task.yml
    input_mapping:
      release-repo: bumped-source
    output_mapping:
      committed-repo: committed-cf-syslog-drain-release
    params:
      COMMIT_MESSAGE: "Bump modules"
  - put: cf-syslog-drain-release
    params:
      repository: committed-cf-syslog-drain-release
      rebase: false

- name: cf-drain-cli-tests
  serial: true
  public: true
  plan:
  - aggregate:
    - get: loggregator-ci
    - get: cf-drain-cli
      trigger: true
  - task: run-tests
    file: loggregator-ci/tasks/go-test-with-latest-packages/task.yml
    input_mapping:
      source-repo: cf-drain-cli
    params:
      IMPORT_PATH: code.cloudfoundry.org/cf-drain-cli

- name: cf-syslog-drain-promotion
  serial: true
  plan:
  - aggregate:
    - get: develop
      resource: cf-syslog-drain-release
      trigger: true
      passed: ["cats", "cfar-lats", "test-releases-can-be-exported"]
    - get: cf-syslog-drain-release-release-elect
  - put: cf-syslog-drain-release-release-elect
    params:
      repository: develop

- name: cf-syslog-drain-master-promotion
  serial: true
  plan:
  - get: 5m
    trigger: true
  - aggregate:
    - get: cf-syslog-drain-release-release-elect
      passed: ["cf-syslog-drain-promotion"]
      trigger: true
    - get: cf-syslog-drain-release-master
    - get: loggregator-ci
  - task: bumper
    file: loggregator-ci/tasks/bumper/task.yml
    input_mapping:
      source: cf-syslog-drain-release-release-elect
      dest: cf-syslog-drain-release-master
    params:
      SOURCE_BRANCH: release-elect
      DEST_BRANCH: master
      FOLLOW_BUMPS_OF: src/code.cloudfoundry.org/scalable-syslog
  - put: cf-syslog-drain-release-master
    params:
      repository: merged-dest

- name: cf-drain-cli-promotion
  serial: true
  plan:
  - get: 5m
    trigger: true
  - aggregate:
    - get: cf-drain-cli
      passed: ["cfar-lats"]
      trigger: true
    - get: cf-drain-cli-master
    - get: loggregator-ci
  - task: bumper
    file: loggregator-ci/tasks/bumper/task.yml
    input_mapping:
      source: cf-drain-cli
      dest: cf-drain-cli-master
    params:
      SOURCE_BRANCH: develop
      DEST_BRANCH: master
  - put: cf-drain-cli-master
    params:
      repository: merged-dest

###############################################################################
# STATSD INJECTOR
###############################################################################
- name: statsd-injector-tests
  serial: true
  public: true
  plan:
  - aggregate:
    - get: loggregator-ci
    - get: 24h
      trigger: true
    - get: statsd-injector-release
      trigger: true
  - task: run-tests
    file: loggregator-ci/tasks/go-bump-modules-and-test/task.yml
    input_mapping:
      source-repo: statsd-injector-release
  - task: commit
    file: loggregator-ci/tasks/commit/task.yml
    input_mapping:
      release-repo: bumped-source
    output_mapping:
      committed-repo: committed-statsd-injector-release
    params:
      COMMIT_MESSAGE: "Bump modules"
  - put: statsd-injector-release
    params:
      repository: committed-statsd-injector-release
      rebase: false

- name: statsd-injector-promotion
  serial: true
  plan:
  - aggregate:
    - get: develop
      resource: statsd-injector-release
      trigger: true
      passed: ["cats", "cfar-lats", "test-releases-can-be-exported"]
    - get: statsd-injector-release-release-elect
  - put: statsd-injector-release-release-elect
    params:
      repository: develop

- name: statsd-injector-master-promotion
  serial: true
  plan:
  - aggregate:
    - get: 5m
      trigger: true
    - get: statsd-injector-release-release-elect
      passed: ["statsd-injector-promotion"]
      trigger: true
    - get: statsd-injector-release-master
    - get: loggregator-ci
  - task: bumper
    file: loggregator-ci/tasks/bumper/task.yml
    input_mapping:
      source: statsd-injector-release-release-elect
      dest: statsd-injector-release-master
    params:
      SOURCE_BRANCH: release-elect
      DEST_BRANCH: master
      FOLLOW_BUMPS_OF: src/code.cloudfoundry.org/statsd-injector
  - put: statsd-injector-release-master
    params:
      repository: merged-dest

###############################################################################
# LEADERSHIP ELECTION
###############################################################################
- name: leadership-election-tests
  serial: true
  public: true
  plan:
  - aggregate:
    - get: loggregator-ci
    - get: 24h
      trigger: true
    - get: leadership-election-release
      trigger: true
  - task: run-tests
    file: loggregator-ci/tasks/go-bump-modules-and-test/task.yml
    input_mapping:
      source-repo: leadership-election-release
  - task: commit
    file: loggregator-ci/tasks/commit/task.yml
    input_mapping:
      release-repo: bumped-source
    output_mapping:
      committed-repo: committed-leadership-election-release
    params:
      COMMIT_MESSAGE: "Bump modules"
  - put: leadership-election-release
    params:
      repository: committed-leadership-election-release
      rebase: false

- name: leadership-election-promotion
  serial: true
  plan:
  - aggregate:
    - get: develop
      resource: leadership-election-release
      trigger: true
      passed: ["cats", "cfar-lats", "test-releases-can-be-exported"]
    - get: leadership-election-release-release-elect
  - put: leadership-election-release-release-elect
    params:
      repository: develop

- name: leadership-election-master-promotion
  serial: true
  plan:
  - aggregate:
    - get: 5m
      trigger: true
    - get: leadership-election-release-release-elect
      passed: ["leadership-election-promotion"]
      trigger: true
    - get: leadership-election-release-master
    - get: loggregator-ci
  - task: bumper
    file: loggregator-ci/tasks/bumper/task.yml
    input_mapping:
      source: leadership-election-release-release-elect
      dest: leadership-election-release-master
    params:
      SOURCE_BRANCH: release-elect
      DEST_BRANCH: master
      FOLLOW_BUMPS_OF: src/code.cloudfoundry.org/leadership-election
  - put: leadership-election-release-master
    params:
      repository: merged-dest

###############################################################################
# SERVICE LOGS
###############################################################################
- name: service-logs-unit-tests
  serial: true
  public: true
  plan:
  - aggregate:
    - get: loggregator-ci
    - get: 24h
      trigger: true
    - get: service-logs-release
      trigger: true
  - task: run-tests
    file: loggregator-ci/tasks/go-bump-modules-and-test/task.yml
    input_mapping:
      source-repo: service-logs-release
  - task: commit
    file: loggregator-ci/tasks/commit/task.yml
    input_mapping:
      release-repo: bumped-source
    output_mapping:
      committed-repo: committed-service-logs-release
    params:
      COMMIT_MESSAGE: "Bump modules"
  - put: service-logs-release
    params:
      repository: committed-service-logs-release
      rebase: false

- name: service-logs-deploy
  serial: true
  plan:
  - aggregate:
    - get: 24h
      trigger: true
    - get: cf-deployment-concourse-tasks
    - get: service-logs-release
      passed: [service-logs-unit-tests]
      trigger: true
    - get: bbl-state
      resource: deployments-loggregator
    - get: loggregator-ci
  - task: upload-service-logs-release
    file: loggregator-ci/tasks/upload-release/task.yml
    input_mapping:
      bosh-release-dir: service-logs-release
    params:
      BBL_STATE_DIR: ((acceptance_bbl_state_dir))
  - task: prepare-ops-files
    file: loggregator-ci/tasks/prepare-service-logs-ops/task.yml
    params:
      ENV_NAME: ((acceptance_env_name))
  - task: deploy-standalone
    file: cf-deployment-concourse-tasks/bosh-deploy/task.yml
    input_mapping:
      vars-store: bbl-state
      ops-files: ops-files
      vars-files: bbl-state
      cf-deployment: service-logs-release
    params:
      SYSTEM_DOMAIN: ((acceptance_system_domain))
      BBL_STATE_DIR: ((acceptance_bbl_state_dir))
      DEPLOYMENT_NAME: test-service-logs
      MANIFEST_FILE: manifests/test-service-logs.yml
      OPS_FILES: |
        on-the-fly.yml

- name: service-logs-smoke-test
  serial: true
  plan:
  - aggregate:
    - get: 24h
      trigger: true
    - get: cf-deployment-concourse-tasks
    - get: service-logs-release
      passed: [service-logs-deploy]
      trigger: true
    - get: bbl-state
      resource: deployments-loggregator
    - get: loggregator-ci
  - task: test-service-logs
    file: loggregator-ci/tasks/service-logs-smoke-test/task.yml
    params:
      BBL_STATE_DIR: ((acceptance_bbl_state_dir))
      CF_API: https://api.((acceptance_system_domain))
      USERNAME: admin
      ORG: system
      SPACE: blackbox-testing

- name: service-logs-promotion
  serial: true
  plan:
  - aggregate:
    - get: develop
      resource: service-logs-release
      passed: ["service-logs-smoke-test", "test-releases-can-be-exported"]
      trigger: true
    - get: service-logs-release-release-elect
  - put: service-logs-release-release-elect
    params:
      repository: develop

- name: service-logs-master-promotion
  serial: true
  plan:
  - aggregate:
    - get: 5m
      trigger: true
    - get: service-logs-release-release-elect
      passed: ["service-logs-promotion"]
      trigger: true
    - get: service-logs-release-master
    - get: loggregator-ci
  - task: bumper
    file: loggregator-ci/tasks/bumper/task.yml
    input_mapping:
      source: service-logs-release-release-elect
      dest: service-logs-release-master
    params:
      SOURCE_BRANCH: release-elect
      DEST_BRANCH: master
      FOLLOW_BUMPS_OF: src/code.cloudfoundry.org/service-logs
  - put: service-logs-release-master
    params:
      repository: merged-dest

###############################################################################
# NOISY NEIGHBOR NOZZLE
###############################################################################
- name: noisy-neighbor-nozzle-tests
  serial: true
  public: true
  plan:
  - aggregate:
    - get: loggregator-ci
    - get: noisy-neighbor-nozzle
      trigger: true
  - task: run-tests
    file: loggregator-ci/tasks/go-test-with-latest-packages/task.yml
    input_mapping:
      source-repo: noisy-neighbor-nozzle
    params:
      IMPORT_PATH: code.cloudfoundry.org/noisy-neighbor-nozzle

- name: noisy-neighbor-nozzle-deploy
  serial: true
  plan:
  - aggregate:
    - get: noisy-neighbor-nozzle
      passed: [noisy-neighbor-nozzle-tests]
      trigger: true
    - get: loggregator-ci
    - get: bbl-state
      resource: deployments-loggregator
  - task: noisy-neighbor-nozzle-deploy
    file: loggregator-ci/tasks/noisy-neighbor-nozzle-deploy/task.yml
    params:
      SYSTEM_DOMAIN: ((acceptance_system_domain))
      APP_DOMAIN: ((acceptance_system_domain))
      ORG: "system"
      SPACE: "accumulators"
      CLIENT_ID: noisy-neighbor-nozzle
      SUBSCRIPTION_ID: {{noisy-neighbor-nozzle-subscription-id}}
      USERNAME: admin
      DATADOG_API_KEY: {{datadog-loggregator-api-key}}
      NOZZLE_COUNT: 4
      BBL_STATE_DIR: ((acceptance_bbl_state_dir))

###############################################################################
# SERVICE METRICS INJECTOR
###############################################################################
- name: service-metrics-tests
  serial: true
  plan:
  - aggregate:
    - get: service-metrics-release
      trigger: true
    - get: loggregator-ci
  - task: run-tests
    file: loggregator-ci/tasks/go-bump-modules-and-test/task.yml
    input_mapping:
      source-repo: service-metrics-release

- name: service-metrics-deploy
  serial: true
  serial_groups: ["cf-deploy"]
  plan:
  - aggregate:
    - get: 24h
      trigger: true
    - get: cf-deployment-concourse-tasks
    - get: service-metrics-release
      trigger: true
      passed: ["service-metrics-tests"]
    - get: deployments-loggregator
    - get: bbl-state
      resource: deployments-loggregator
    - get: loggregator-ci
  - task: upload-service-metrics-release
    file: loggregator-ci/tasks/upload-release/task.yml
    input_mapping:
      bosh-release-dir: service-metrics-release
    params:
      BBL_STATE_DIR: ((acceptance_bbl_state_dir))
  - task: copy-ops-files
    file: loggregator-ci/tasks/prepare-service-metrics-ops-and-vars/task.yml
    params:
      ENV_NAME: ((acceptance_env_name))
      BBL_STATE_DIR: ((acceptance_bbl_state_dir))

  - task: deploy-standalone
    file: cf-deployment-concourse-tasks/bosh-deploy/task.yml
    input_mapping:
      vars-store: bbl-state
      ops-files: ops-files
      cf-deployment: service-metrics-release
    params:
      SYSTEM_DOMAIN: ((acceptance_system_domain))
      BBL_STATE_DIR: ((acceptance_bbl_state_dir))
      DEPLOYMENT_NAME: service-metrics-injector
      MANIFEST_FILE: manifests/manifest.yml
      OPS_FILES: |
        on-the-fly.yml

- name: service-metrics-smoke-tests
  serial: true
  plan:
    - aggregate:
        - get: 24h
          trigger: true
        - get: cf-deployment-concourse-tasks
        - get: service-metrics-release
          passed: [service-metrics-deploy]
          trigger: true
        - get: bbl-state
          resource: deployments-loggregator
        - get: loggregator-ci
    - task: test-service-metrics
      file: loggregator-ci/tasks/service-metrics-smoke-test/task.yml
      params:
        BBL_STATE_DIR: ((acceptance_bbl_state_dir))
        CF_API: https://api.((acceptance_system_domain))
        USERNAME: admin
        SOURCE_ID: dummy-source-id

- name: service-metrics-promotion
  serial: true
  plan:
  - aggregate:
    - get: develop
      resource: service-metrics-release
      trigger: true
      passed: ["service-metrics-smoke-tests", "test-releases-can-be-exported"]
    - get: service-metrics-release-release-elect
  - put: service-metrics-release-release-elect
    params:
      repository: develop

- name: service-metrics-master-promotion
  serial: true
  plan:
  - get: 5m
    trigger: true
  - aggregate:
    - get: service-metrics-release-release-elect
      passed: ["service-metrics-promotion"]
      trigger: true
    - get: service-metrics-release-master
    - get: loggregator-ci
  - task: bumper
    file: loggregator-ci/tasks/bumper/task.yml
    input_mapping:
      source: service-metrics-release-release-elect
      dest: service-metrics-release-master
    params:
      SOURCE_BRANCH: release-elect
      DEST_BRANCH: master
      FOLLOW_BUMPS_OF: src/code.cloudfoundry.org/service-metrics
  - put: service-metrics-release-master
    params:
      repository: merged-dest
###############################################################################
# SHARED
###############################################################################
- name: cf-deploy
  serial: true
  serial_groups:
  - cf-deploy
  - bosh-cf-cats
  - bosh-cfar-lats
  plan:
  - aggregate:
    - get: loggregator-ci
    - get: denver-deployments
    - get: bbl-state
      resource: deployments-loggregator
    - get: cf-deployment
      trigger: true
    - get: cf-deployment-concourse-tasks
    - get: loggregator-release
      passed: ["loggregator-tests"]
      trigger: true
    - get: loggregator-agent-release
      passed: ["loggregator-agent-tests"]
      trigger: true
    - get: cf-syslog-drain-release
      trigger: true
      passed: [cf-syslog-drain-tests]
    - get: statsd-injector-release
      passed: [statsd-injector-tests]
      trigger: true
    - get: leadership-election-release
      passed: [leadership-election-tests]
      trigger: true
    - get: cf-drain-cli
      passed:
      - cf-drain-cli-tests
    - get: log-stream-cli
      passed:
      - log-stream-cli-tests
  - aggregate:
    - task: upload-loggregator-release
      file: loggregator-ci/tasks/upload-release/task.yml
      input_mapping:
        bosh-release-dir: loggregator-release
      params:
        BBL_STATE_DIR: ((acceptance_bbl_state_dir))
    - task: upload-loggregator-agent-release
      file: loggregator-ci/tasks/upload-release/task.yml
      input_mapping:
        bosh-release-dir: loggregator-agent-release
      params:
        BBL_STATE_DIR: ((acceptance_bbl_state_dir))
    - task: upload-cf-syslog-drain-release
      file: loggregator-ci/tasks/upload-release/task.yml
      input_mapping:
        bosh-release-dir: cf-syslog-drain-release
      params:
        BBL_STATE_DIR: ((acceptance_bbl_state_dir))
    - task: upload-statsd-injector-release
      file: loggregator-ci/tasks/upload-release/task.yml
      input_mapping:
        bosh-release-dir: statsd-injector-release
      params:
        BBL_STATE_DIR: ((acceptance_bbl_state_dir))
    - task: upload-leadership-election-release
      file: loggregator-ci/tasks/upload-release/task.yml
      input_mapping:
        bosh-release-dir: leadership-election-release
      params:
        BBL_STATE_DIR: ((acceptance_bbl_state_dir))
  - task: copy-ops-files
    file: loggregator-ci/tasks/prepare-cf-ops/task.yml
    params:
      BBL_STATE_DIR: ((acceptance_bbl_state_dir))
  - task: cf-deploy
    file: cf-deployment-concourse-tasks/bosh-deploy/task.yml
    input_mapping:
      vars-files: bbl-state
    params:
      BBL_STATE_DIR: ((acceptance_bbl_state_dir))
      SYSTEM_DOMAIN: ((acceptance_system_domain))
      OPS_FILES: |
        scale-to-one-az.yml
        use-compiled-releases.yml
        use-compiled-releases-windows.yml
        add-metric-store.yml
        loggregator-clients.yml

        windows1803-cell.yml
        use-latest-windows1803-stemcell.yml

        cf-deployment-addon.yml
        cf-add-syslog-agent.yml
        cf-deployment-add-system-metrics-agent.yml
        cf-add-system-metric-scraper.yml
        cf-syslog-agent-skip-cert-verify.yml
        cf-deployment-windows-addon.yml
        cf-syslog-agent-skip-cert-verify-windows.yml
        use-provided-router-certs.yml

        loggregator-acceptance.yml
      VARS_FILES: ""
  - task: enable-feature-flags
    file: cf-deployment-concourse-tasks/set-feature-flags/task.yml
    attempts: 3
    params:
      SYSTEM_DOMAIN: ((acceptance_system_domain))
      BBL_STATE_DIR: ((acceptance_bbl_state_dir))
      ENABLED_FEATURE_FLAGS: diego_docker
  - task: cleanup
    file: cf-deployment-concourse-tasks/bosh-cleanup/task.yml
    params:
      BBL_STATE_DIR: ((acceptance_bbl_state_dir))
  - task: create-blackbox-space
    file: loggregator-ci/tasks/create-org-and-space/task.yml
    params:
      BBL_STATE_DIR: ((acceptance_bbl_state_dir))
      ORG: system
      SPACE: blackbox-testing
      SYSTEM_DOMAIN: ((acceptance_system_domain))
  - task: create-accumulators-space
    file: loggregator-ci/tasks/create-org-and-space/task.yml
    params:
      BBL_STATE_DIR: ((acceptance_bbl_state_dir))
      ORG: system
      SPACE: accumulators
      SYSTEM_DOMAIN: ((acceptance_system_domain))

- name: test-releases-can-be-exported
  serial: true
  plan:
  - aggregate:
    - get: concourse-tasks
    - get: bbl-state
      resource: deployments-loggregator
    - get: loggregator-release
      trigger: true
      passed: ["cf-deploy"]
    - get: loggregator-agent-release
      trigger: true
      passed: ["cf-deploy"]
    - get: cf-syslog-drain-release
      passed: ["cf-deploy"]
      trigger: true
    - get: statsd-injector-release
      passed: ["cf-deploy"]
      trigger: true
    - get: leadership-election-release
      passed: ["cf-deploy"]
      trigger: true
    - get: service-logs-release
      passed: ["service-logs-deploy"]
      trigger: true
    - get: service-metrics-release
      passed: ["service-metrics-deploy"]
      trigger: true
  - task: export-releases
    file: concourse-tasks/release/export/task.yml
    params:
      BBL_STATE_DIR: ((acceptance_bbl_state_dir))
      RELEASE_NAMES: |
        loggregator
        loggregator-agent
        cf-syslog-drain
        statsd-injector
        leadership-election
        service-logs
        service-metrics
  - task: show-releases
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: loggregator/base
      inputs:
      - name: exported-releases
      run:
        path: /bin/bash
        args:
        - "-c"
        - |
          set -exuo pipefail
          ls exported-releases

- name: cats
  serial: true
  serial_groups:
  - bosh-cf-cats
  plan:
  - aggregate:
    - get: loggregator-ci
    - get: cf-deployment-concourse-tasks
    - get: deployments-loggregator
    - get: cf-acceptance-tests
    - get: loggregator-release
      passed: [cf-deploy]
      trigger: true
    - get: loggregator-agent-release
      passed: [cf-deploy]
      trigger: true
    - get: cf-syslog-drain-release
      trigger: true
      passed: [cf-deploy]
    - get: statsd-injector-release
      passed: [cf-deploy]
      trigger: true
    - get: leadership-election-release
      passed: [cf-deploy]
      trigger: true
  - task: generate-config
    file: loggregator-ci/tasks/generate-cats-config/task.yml
    input_mapping:
      bbl-state: deployments-loggregator
    params:
      BBL_STATE_DIR: ((acceptance_bbl_state_dir))
      SYSTEM_DOMAIN: ((acceptance_system_domain))
  - task: run-cats
    file: cf-deployment-concourse-tasks/run-cats/task.yml
    input_mapping:
      integration-config: cats-config
      cf-acceptance-tests: cf-acceptance-tests
    params:
      CONFIG_FILE_PATH: cats-config.json
      NODES: 9

- name: cfar-lats
  serial: true
  serial_groups:
  - bosh-cfar-lats
  plan:
  - aggregate:
    - get: cfar-logging-acceptance-tests
      trigger: true
    - get: loggregator-release
      passed: [cf-deploy]
      trigger: true
    - get: loggregator-agent-release
      passed: [cf-deploy]
      trigger: true
    - get: cf-syslog-drain-release
      trigger: true
      passed: [cf-deploy]
    - get: statsd-injector-release
      passed: [cf-deploy]
      trigger: true
    - get: leadership-election-release
      passed: [cf-deploy]
      trigger: true
    - get: cf-drain-cli
      passed: ["cf-deploy"]
      trigger: true
    - get: log-stream-cli
      passed: ["log-stream-cli-tests"]
      trigger: true
    - get: loggregator-ci
    - get: bbl-state
      resource: deployments-loggregator
    - get: cf-drain-cli-master
  - task: run-cfar-lats
    input_mapping:
      cf-drain-cli: cf-drain-cli-master
    file: loggregator-ci/tasks/cfar-lats/task.yml
    params:
      CF_ADMIN_USER: admin
      CF_DOMAIN: ((acceptance_system_domain))
      BBL_STATE_DIR: ((acceptance_bbl_state_dir))
      SKIP_SSL_VALIDATION: true
      APP_PUSH_TIMEOUT: 180s
