<%
class Release
  attr_reader :name, :backport_branches, :s3_bucket
  def initialize(name, backport_branches, s3_bucket)
    @name = name
    @s3_bucket = s3_bucket
    @backport_branches = backport_branches
  end
end

releases = [
  Release.new("cf-syslog-drain", %w(v8.2.x v10.2.x), "cf-syslog-drain-release-blobs"),
  Release.new("leadership-election", %w(v1.4.x), "leadership-election-release-blobs"),
  Release.new("log-cache", %w(v2.1.x), "log-cache-release-blobs"),
  Release.new("loggregator", %w(v103.x v105.5.x v105.6.x), "loggregator-release-blobs"),
  Release.new("loggregator-agent", %w(v2.3.x v3.16.x v3.21.x), "loggregator-agent-release-blobs"),
  Release.new("service-metrics", %w(v1.12.x), "oss-service-metrics-release-blobs"),
]
%>

groups:
- name: all
  jobs:
<% releases.sort_by { |release| release.name }.each do |release| %>
<% release.backport_branches.each do |backport_branch| %>
  - <%= release.name %>-create-backport-<%= backport_branch %>
<% end %>
<% end %>

<% releases.sort_by { |release| release.name }.each do |release| %>
- name: <%= release.name %>
  jobs:
<% release.backport_branches.each do |backport_branch| %>
  - <%= release.name %>-create-backport-<%= backport_branch %>
<% end %>
<% end %>

resources:
- name: loggregator-ci
  type: git
  source:
    uri: git@github.com:cloudfoundry/loggregator-ci.git
    private_key: {{loggregator-key}}

<% releases.each do |release| %>
<% release.backport_branches.each do |backport_branch| %>
- name: <%= release.name %>-release-backport-<%= backport_branch %>
  type: git
  source:
    branch: <%= backport_branch %>
    uri: git@github.com:cloudfoundry/<%= release.name %>-release
    private_key: {{cf-loggregator-oauth-bot-key}}
<% end %>

- name: <%= release.name %>-github-release-drafts
  type: github-release
  source:
    user: cloudfoundry
    repository: <%= release.name %>-release
    access_token: {{access-token}}
    drafts: true
<% end %>

jobs:
<% releases.each do |release| %>
<% release.backport_branches.each do |backport_branch| %>
- name: <%= release.name %>-create-backport-<%= backport_branch %>
  serial: true
  plan:
  - get: <%= release.name %>-release-backport-<%= backport_branch %>
    trigger: false
  - get: loggregator-ci
  - task: create-backport
    input_mapping:
      release-repo: <%= release.name %>-release-backport-<%= backport_branch %>
    file: loggregator-ci/tasks/create-final-release/backport/task.yml
    params:
      S3_ACCESS_KEY: {{s3-access-key-id}}
      S3_SECRET_KEY: {{s3-secret-access-key}}
      JSON_KEY: {{gcp-service-account-key}}
      SSH_KEY: {{loggregator-key}}
      BLOBSTORE_BUCKET: <%= release.s3_bucket %>
      BRANCH_NAME: <%= backport_branch %>
  - put: <%= release.name %>-release-backport-<%= backport_branch %>
    params:
      repository: repos/release-repo
      rebase: false
  - put: <%= release.name %>-github-release-drafts
    params:
      name: github-release/name
      tag: github-release/tag
      body: github-release/body
      globs:
      - github-release/*.tgz
<% end %>
<% end %>
