resources:
- name: 15m
  type: time
  source: {interval: 15m}
- name: 1h
  type: time
  source: {interval: 1h}
- name: daily
  type: time
  source:
    start: 8:00 PM
    stop: 9:00 PM
    location: America/Denver
- name: loggregator-ci
  type: git
  source:
    uri: https://github.com/cloudfoundry/loggregator-ci
- name: loggregator
  type: git
  source:
    uri: https://github.com/cloudfoundry/loggregator-release
    branch: develop
- name: loggregator-tools
  type: git
  source:
    uri: https://github.com/cloudfoundry-incubator/loggregator-tools

jobs:
- name: restage-logspinners
  public: false
  serial: true
  serial_groups: ["restage"]
  plan:
  - get: daily
    trigger: true
  - get: loggregator-ci
  - get: loggregator-tools
  - task: restage-logspinner
    file: loggregator-ci/tasks/restage-apps.yml
    params:
      APP_NAMES: "trkr-floodspinner trkr-dripspinner trkr-flowspinner"
      CF_API: "api.gcp.trackerred.com"
      ORG: "system"
      SPACE: "loggregator-sli"
      USERNAME: {{trkr-username}}
      PASSWORD: {{trkr-password}}

- name: floodspinner
  public: false
  serial: true
  serial_groups: ["restage"]
  plan:
  - get: loggregator-ci
  - get: 15m
    trigger: true
  - task: run-smoke-tests
    file: loggregator-ci/tasks/blackbox/task.yml
    params:
      CYCLES: 10000
      DELAY: "2"
      DELAY_UNIT: "us"
      APP_NAME: "trkr-floodspinner"
      WAIT: 60
      MESSAGE: "FIFTEEN-MINUTE"
      DATADOG_API_KEY: ((datadog-loggregator-api-key)) ((datadog-cloudops-eu-api-key))
      APP_DOMAIN: "trkr-floodspinner.gcp.trkr.io"
      CF_API: "api.gcp.trackerred.com"
      ORG: "system"
      SPACE: "loggregator-sli"
      USERNAME: {{trkr-username}}
      PASSWORD: {{trkr-password}}
    timeout: 15m
  - task: run-recent-logs-smoke-tests
    file: loggregator-ci/tasks/blackbox-recent-logs/task.yml
    params: &basic-smoke-details
      APP_NAME: "trkr-floodspinner"
      DATADOG_API_KEY: ((datadog-loggregator-api-key)) ((datadog-cloudops-eu-api-key))
      LOGGREGATOR_ADDR: "wss://doppler.gcp.trackerred.com:443"
      CF_API: "api.gcp.trackerred.com"
      ORG: "system"
      SPACE: "loggregator-sli"
      USERNAME: {{trkr-username}}
      PASSWORD: {{trkr-password}}
    timeout: 15m
  - task: container metrics
    file: loggregator-ci/tasks/container-metrics-smoke-test.yml
    params: *basic-smoke-details
    timeout: 15m

- name: dripspinner
  public: false
  serial: true
  serial_groups: ["restage"]
  plan:
  - get: loggregator-ci
  - get: 1h
    trigger: true
  - task: run-smoke-tests
    file: loggregator-ci/tasks/blackbox/task.yml
    params:
      CYCLES: 1000
      DELAY: "500"
      DELAY_UNIT: "ms"
      APP_NAME: "trkr-dripspinner"
      WAIT: 600
      MESSAGE: "HOURLY"
      DATADOG_API_KEY: ((datadog-loggregator-api-key)) ((datadog-cloudops-eu-api-key))
      APP_DOMAIN: "trkr-dripspinner.gcp.trkr.io"
      CF_API: "api.gcp.trackerred.com"
      ORG: "system"
      SPACE: "loggregator-sli"
      USERNAME: {{trkr-username}}
      PASSWORD: {{trkr-password}}
    timeout: 15m

- name: flowspinner
  public: false
  serial: true
  serial_groups: ["restage"]
  plan:
  - get: loggregator-ci
  - get: 1h
    trigger: true
  - task: run-smoke-tests
    file: loggregator-ci/tasks/blackbox/task.yml
    params:
      CYCLES: 1000
      DELAY: "1"
      DELAY_UNIT: "ms"
      APP_NAME: "trkr-flowspinner"
      WAIT: 60
      MESSAGE: "HOURLY"
      DATADOG_API_KEY: ((datadog-loggregator-api-key)) ((datadog-cloudops-eu-api-key))
      APP_DOMAIN: "trkr-flowspinner.gcp.trkr.io"
      CF_API: "api.gcp.trackerred.com"
      ORG: "system"
      SPACE: "loggregator-sli"
      USERNAME: {{trkr-username}}
      PASSWORD: {{trkr-password}}
    timeout: 15m

- name: latency
  public: false
  serial: true
  plan:
  - get: loggregator
  - get: loggregator-ci
  - get: 15m
    trigger: true
  - task: run-latency-tests
    file: loggregator-ci/tasks/latency-test.yml
    params:
      APP_DOMAIN: "loggregator-latency.gcp.trkr.io"
      APP_NAME: "loggregator-latency"
      DATADOG_API_KEY: ((datadog-loggregator-api-key)) ((datadog-cloudops-eu-api-key))
      CF_API: "api.gcp.trackerred.com"
      ORG: "system"
      SPACE: "loggregator-sli"
      USERNAME: {{trkr-username}}
      PASSWORD: {{trkr-password}}
    timeout: 15m
