groups:
- name: main
  jobs:
  - start-pipeline
  - latest-deploy
  - release-elect-deploy
  - setup
  - smoke-tests
  - start-incidents
  - firehose-reliability
- name: director-lifecycle
  jobs:
  - latest-bbl-create
  - latest-bbl-destroy
  - release-elect-bbl-create
  - release-elect-bbl-destroy

resource_types:
  - name: slack-notification
    type: docker-image
    source:
      repository: cfcommunity/slack-notification-resource
      tag: latest

resources:
  - name: loggregator-release-elect
    type: git
    source:
      uri: git@github.com:cloudfoundry/loggregator.git
      branch: release-elect
      private_key: {{loggregator-key}}
      ignore_paths:
        - .final_builds
        - releases

  - name: loggregator-develop
    type: git
    source:
      uri: git@github.com:cloudfoundry/loggregator.git
      branch: develop
      private_key: {{loggregator-key}}
      ignore_paths:
      - .final_builds
      - releases

  - name: loggregator-latest
    type: bosh-io-release
    source:
      repository: cloudfoundry/loggregator

  - name: loggregator-tools
    type: git
    source:
      uri: https://github.com/cloudfoundry-incubator/loggregator-tools

  - name: cf-syslog-drain-release-elect
    type: git
    source:
      uri: http://github.com/cloudfoundry/cf-syslog-drain-release.git
      branch: release-elect
      ignore_paths:
      - .final_builds
      - releases

  - name: cf-syslog-drain-develop
    type: git
    source:
      uri: https://github.com/cloudfoundry/cf-syslog-drain-release.git
      branch: develop
      ignore_paths:
      - .final_builds
      - releases

  - name: cf-syslog-drain-latest
    type: bosh-io-release
    source:
      repository: cloudfoundry/cf-syslog-drain-release

  - name: consul-release
    type: bosh-io-release
    source:
      repository: cloudfoundry-incubator/consul-release

  - name: deployments-loggregator
    type: git
    source: &deployments_loggregator
      uri: git@github.com:cloudfoundry/deployments-loggregator.git
      branch: master
      private_key: {{deployments-loggregator-key}}

  - name: deployments-loggregator-with-changes
    type: git
    source: *deployments_loggregator

  - name: cf-deployment
    type: git
    source:
      uri: https://github.com/cloudfoundry/cf-deployment
      branch: master

  - name: cf-deployment-concourse-tasks
    type: git
    source:
      uri: https://github.com/cloudfoundry/cf-deployment-concourse-tasks
      branch: v4.5

  - name: loggregator-ci
    type: git
    source:
      uri: https://github.com/cloudfoundry/loggregator-ci

  - name: pipeline-lock
    type: pool
    source:
      uri: git@github.com:cloudfoundry/loggregator-locks.git
      branch: master
      pool: science
      private_key: {{cf-loggregator-oauth-bot-key}}

  - name: 10m
    type: time
    source: {interval: 10m}

  - name: 20m
    type: time
    source: {interval: 20m}

  - name: 2h
    type: time
    source: {interval: 2h}

  - name: daily
    type: time
    source:
      start: 8:00 PM
      stop: 9:00 PM
      location: America/Denver

  - name: slack-alert
    type: slack-notification
    source:
      url: {{slack-bot-url}}

jobs:
- name: release-elect-bbl-create
  plan:
  - get: cf-deployment-concourse-tasks
  - get: bbl-state
    resource: deployments-loggregator
  - get: ops-files
    resource: deployments-loggregator
  - task: bbl-up
    file: cf-deployment-concourse-tasks/bbl-up/task.yml
    params:
      BBL_GCP_SERVICE_ACCOUNT_KEY: service-account.key.json
      BBL_GCP_PROJECT_ID: cff-loggregator
      BBL_GCP_ZONE: us-central1-a
      BBL_GCP_REGION: us-central1
      BBL_STATE_DIR: gcp/science/release-elect
      BBL_IAAS: gcp
      BBL_LB_CERT: {{coconut_bbl_lb_cert}}
      BBL_LB_KEY: {{coconut_bbl_lb_key}}
      BBL_ENV_NAME: release-elect-science
      LB_DOMAIN: release-elect.science.loggr.cf-app.com
  - put: deployments-loggregator-with-changes
    params:
      repository: updated-bbl-state
      rebase: true
- name: release-elect-bbl-destroy
  plan:
  - get: cf-deployment-concourse-tasks
  - get: bbl-state
    resource: deployments-loggregator
  - task: bbl-destroy
    file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
    params:
      BBL_STATE_DIR: gcp/science/release-elect
  - put: deployments-loggregator-with-changes
    params:
      repository: updated-bbl-state
      rebase: true

- name: latest-bbl-create
  plan:
  - get: cf-deployment-concourse-tasks
  - get: bbl-state
    resource: deployments-loggregator
  - get: ops-files
    resource: deployments-loggregator
  - task: bbl-up
    file: cf-deployment-concourse-tasks/bbl-up/task.yml
    params:
      BBL_GCP_SERVICE_ACCOUNT_KEY: service-account.key.json
      BBL_GCP_PROJECT_ID: cff-loggregator
      BBL_GCP_ZONE: us-central1-a
      BBL_GCP_REGION: us-central1
      BBL_STATE_DIR: gcp/science/latest
      BBL_IAAS: gcp
      BBL_LB_CERT: {{coconut_bbl_lb_cert}}
      BBL_LB_KEY: {{coconut_bbl_lb_key}}
      BBL_ENV_NAME: latest-science
      LB_DOMAIN: latest.science.loggr.cf-app.com
  - put: deployments-loggregator-with-changes
    params:
      repository: updated-bbl-state
      rebase: true
- name: latest-bbl-destroy
  plan:
  - get: cf-deployment-concourse-tasks
  - get: bbl-state
    resource: deployments-loggregator
  - task: bbl-destroy
    file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
    params:
      BBL_STATE_DIR: gcp/science/latest
  - put: deployments-loggregator-with-changes
    params:
      repository: updated-bbl-state
      rebase: true

- name: start-pipeline
  serial: true
  serial_groups: ["locking"]
  plan:
    - get: daily
      trigger: true
    - get: pipeline-lock
    - put: pipeline-lock
      params:
        claim: pipeline

- name: release-elect-deploy
  serial: true
  serial_groups: ["release-elect"]
  plan:
    - aggregate:
      - get: pipeline-lock
        passed: ["start-pipeline"]
        trigger: true
      - get: bbl-state
        resource: deployments-loggregator
      - get: cf-deployment
      - get: cf-deployment-concourse-tasks
      - get: loggregator
        resource: loggregator-release-elect
      - get: vars-store
        resource: deployments-loggregator
      - get: vars-files
        resource: deployments-loggregator
      - get: consul-release
      - get: cf-syslog-drain
        resource: cf-syslog-drain-release-elect
    - do:
      - task: upload-stemcell
        file: cf-deployment-concourse-tasks/bosh-upload-stemcell-from-cf-deployment/task.yml
        params:
          BBL_STATE_DIR: gcp/science/release-elect
      - task: upload-releases
        config:
          platform: linux
          image_resource:
            type: docker-image
            source:
              repository: relintdockerhubpushbot/cf-deployment-concourse-tasks
          inputs:
          - name: bbl-state
          - name: loggregator
          - name: cf-syslog-drain
          run:
            path: /bin/bash
            args:
            - "-c"
            - |
              #!/bin/bash

              set -ex

              pushd bbl-state/gcp/playground
                export BOSH_CLIENT=`bbl director-username`
                export BOSH_CLIENT_SECRET=`bbl director-password`
                export BOSH_CA_CERT=`bbl director-ca-cert`
                export BOSH_ENVIRONMENT=`bbl director-address`
              popd

              releases="loggregator cf-syslog-drain"
              for rel in $releases; do
                pushd $rel
                  bosh create-release
                  bosh upload-release --rebase
                popd
              done
      - task: copy-ops-files
        config:
          platform: linux
          image_resource:
            type: docker-image
            source: { repository: ubuntu }
          inputs:
          - name: bbl-state
          - name: cf-deployment
          outputs:
          - name: ops-files
          run:
            path: /bin/bash
            args:
            - "-c"
            - |
              #!/bin/bash
              set -ex

              cp bbl-state/gcp/science/release-elect/ops-files/*.yml ops-files/
      - task: cf-deploy
        file: cf-deployment-concourse-tasks/bosh-deploy/task.yml
        params:
          BBL_STATE_DIR: gcp/science/release-elect
          SYSTEM_DOMAIN: release-elect.science.loggr.cf-app.com
          VARS_STORE_FILE: gcp/science/release-elect/deployment-vars.yml
          VARS_FILES: "gcp/science/release-elect/datadog-vars.yml gcp/science/release-elect/turbulence-vars.yml"
          OPS_FILES: "clients.yml turbulence-cf.yml turbulence-scalable-syslog.yml allow-insecure-syslog-drains.yml cf-versions.yml"
      - put: deployments-loggregator-with-changes
        params:
          repository: updated-vars-store
          rebase: true
      on_failure: &slack-failure-alert
        put: slack-alert
        params:
          text: |
            The `science` pipeline has failed. Please resolve any issues and ensure the pipeline lock was released. Check it out at:
            $ATC_EXTERNAL_URL/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME

- name: latest-deploy
  serial: true
  serial_groups: ["latest"]
  plan:
    - aggregate:
      - get: pipeline-lock
        passed: ["start-pipeline"]
        trigger: true
      - get: bbl-state
        resource: deployments-loggregator
      - get: cf-deployment
      - get: cf-deployment-concourse-tasks
      - get: vars-store
        resource: deployments-loggregator
      - get: loggregator-latest
      - get: vars-files
        resource: deployments-loggregator
      - get: consul-release
      - get: cf-syslog-drain-develop
      - get: cf-syslog-drain-latest
    - do:
      - task: upload-stemcell
        file: cf-deployment-concourse-tasks/bosh-upload-stemcell-from-cf-deployment/task.yml
        params:
          BBL_STATE_DIR: gcp/science/latest
      - task: copy-ops-files
        config:
          platform: linux
          image_resource:
            type: docker-image
            source: { repository: ubuntu }
          inputs:
          - name: bbl-state
          - name: cf-deployment
          - name: loggregator-latest
          - name: cf-syslog-drain-latest
          outputs:
          - name: ops-files
          run:
            path: /bin/bash
            args:
            - "-c"
            - |
              #!/bin/bash
              set -ex

              cp bbl-state/gcp/science/latest/ops-files/*.yml ops-files/

              loggregator_version=$(cat loggregator-latest/version)
              loggregator_sha=$(cat loggregator-latest/sha1)

              cf_syslog_drain_version=$(cat cf-syslog-drain-latest/version)
              cf_syslog_drain_sha=$(cat cf-syslog-drain-latest/sha1)

              cat <<EOT >> ops-files/loggregator-version.yml
              - type: replace
                path: /releases/name=loggregator
                value:
                  name: loggregator
                  url: https://bosh.io/d/github.com/cloudfoundry/loggregator?v=$loggregator_version
                  version: "$loggregator_version"
                  sha1: "$loggregator_sha"
              - type: replace
                path: /releases/name=cf-syslog-drain
                value:
                  name: cf-syslog-drain
                  url: https://bosh.io/d/github.com/cloudfoundry/cf-syslog-drain-release?v=$cf_syslog_drain_version
                  version: "$cf_syslog_drain_version"
                  sha1: "$cf_syslog_drain_sha"
              EOT
      - task: cf-deploy
        file: cf-deployment-concourse-tasks/bosh-deploy/task.yml
        params:
          BBL_STATE_DIR: gcp/science/latest
          SYSTEM_DOMAIN: latest.science.loggr.cf-app.com
          VARS_STORE_FILE: gcp/science/latest/deployment-vars.yml
          VARS_FILES: "gcp/science/latest/datadog-vars.yml gcp/science/latest/turbulence-vars.yml"
          OPS_FILES: "clients.yml loggregator-version.yml turbulence-scalable-syslog.yml allow-insecure-syslog-drains.yml turbulence-cf.yml"
      - put: deployments-loggregator-with-changes
        params:
          repository: updated-vars-store
          rebase: true
      on_failure: *slack-failure-alert

- name: setup
  serial: true
  serial_groups: ["release-elect", "latest"]
  plan:
    - aggregate:
      - get: pipeline-lock
        passed: ["latest-deploy", "release-elect-deploy"]
        trigger: true
      - get: vars-store
        resource: deployments-loggregator-with-changes
      - get: loggregator
        resource: loggregator-develop
      - get: release-elect
        passed: ["release-elect-deploy"]
        resource: loggregator-release-elect
      - get: release-latest
        passed: ["latest-deploy"]
        resource: loggregator-latest
      - get: loggregator-ci
      - get: loggregator-tools
    - do:
      - aggregate:
        - task: setup-release-elect
          file: loggregator-ci/tasks/science/setup-cf.yml
          params:
            SYSTEM_DOMAIN: release-elect.science.loggr.cf-app.com
            VARS_STORE_FILE: gcp/science/release-elect/deployment-vars.yml
            ORG: cf-lamb
            SPACE: development
        - task: setup-latest
          file: loggregator-ci/tasks/science/setup-cf.yml
          params:
            SYSTEM_DOMAIN: latest.science.loggr.cf-app.com
            VARS_STORE_FILE: gcp/science/latest/deployment-vars.yml
            ORG: cf-lamb
            SPACE: development
        - task: setup-event
          file: loggregator-ci/tasks/science/setup-datadog-event.yml
          params:
            DATADOG_API_KEY: {{datadog-dev-api-key}}
            DATADOG_APP_KEY: {{datadog-dev-app-key}}
            LATEST_SYSTEM_DOMAIN: latest.science.loggr.cf-app.com
            ELECT_SYSTEM_DOMAIN: release-elect.science.loggr.cf-app.com
      - put: pipeline-lock
        params:
          release: pipeline-lock
      timeout: 5m
      on_failure: *slack-failure-alert

- name: smoke-tests
  serial: true
  serial_groups: ["locking"]
  plan:
    - get: pipeline-lock
    - put: pipeline-lock
      params:
        claim: "pipeline"
    - aggregate:
      - get: loggregator-tools
      - get: vars-store
        resource: deployments-loggregator-with-changes
      - get: release-elect
        resource: loggregator-release-elect
        passed: ["setup"]
      - get: release-latest
        resource: loggregator-latest
        passed: ["setup"]
      - get: loggregator-ci
    - get: 20m
      trigger: true
    - aggregate:
      - do:
        - task: get-release-version
          config:
            platform: linux
            image_resource:
              type: docker-image
              source:
                repository: loggregator/base
            inputs:
              - name: release-elect
            outputs:
              - name: release-info
            run:
              path: bash
              args:
              - -c
              - |
                #/bin/bash
                set -ex

                cd release-elect
                git rev-parse HEAD > ../release-info/version
        - task: loggregator-elect
          file: loggregator-ci/tasks/science/cf-logs-smoke-test.yml
          params:
            PREFIX: "regression."
            CYCLES: 10000
            DELAY: "2"
            DELAY_UNIT: "us"
            MESSAGE: "FIFTEEN-MINUTE"
            APP_NAME: "floodspinner"
            WAIT: 60
            API_ENDPOINT: api.release-elect.science.loggr.cf-app.com
            USERNAME: admin
            DATADOG_API_KEY: {{datadog-dev-api-key}}
            SKIP_SSL_VALIDATION: true
            VARS_STORE_FILE: gcp/science/release-elect/deployment-vars.yml
            VERSION_TAG: elect
      - task: http-drain
        file: loggregator-ci/tasks/cf-syslog-drain-smoke-test-with-vars.yml
        params:
          CF_ORG: cf-lamb
          CF_SPACE: development
          CF_APP_DOMAIN: release-elect.science.loggr.cf-app.com
          CF_SYSTEM_DOMAIN: release-elect.science.loggr.cf-app.com
          CF_USERNAME: admin
          DATADOG_API_KEY: {{datadog-loggregator-api-key}}
          DRAIN_VERSION: "2.0"
          DRAIN_TYPE: "https"
          JOB_NAME: "https-teardown"
          TEARDOWN: false
          VARS_STORE_FILE: gcp/science/release-elect/deployment-vars.yml
        timeout: 20m
      - task: tcp-drain
        file: loggregator-ci/tasks/cf-syslog-drain-smoke-test-with-vars.yml
        params:
          CF_ORG: cf-lamb
          CF_SPACE: development
          CF_APP_DOMAIN: tcp.release-elect.science.loggr.cf-app.com
          CF_SYSTEM_DOMAIN: release-elect.science.loggr.cf-app.com
          CF_USERNAME: admin
          DATADOG_API_KEY: {{datadog-loggregator-api-key}}
          DRAIN_VERSION: "2.0"
          DRAIN_TYPE: "syslog"
          JOB_NAME: "syslog-teardown"
          VARS_STORE_FILE: gcp/science/release-elect/deployment-vars.yml
        timeout: 20m
      - do:
        - task: get-release-version
          config:
            platform: linux
            image_resource:
              type: docker-image
              source:
                repository: loggregator/base
            inputs:
              - name: release-latest
            outputs:
              - name: release-info
            run:
              path: bash
              args:
              - -c
              - |
                #/bin/bash
                set -ex

                cp release-latest/version release-info/version
        - task: loggregator-latest
          file: loggregator-ci/tasks/science/cf-logs-smoke-test.yml
          params:
            PREFIX: "regression."
            CYCLES: 10000
            DELAY: "2"
            DELAY_UNIT: "us"
            MESSAGE: "FIFTEEN-MINUTE"
            APP_NAME: "floodspinner"
            WAIT: 60
            API_ENDPOINT: api.latest.science.loggr.cf-app.com
            USERNAME: admin
            DATADOG_API_KEY: {{datadog-dev-api-key}}
            SKIP_SSL_VALIDATION: true
            VARS_STORE_FILE: gcp/science/latest/deployment-vars.yml
            VERSION_TAG: latest
      - task: http-drain
        file: loggregator-ci/tasks/cf-syslog-drain-smoke-test-with-vars.yml
        params:
          CF_ORG: cf-lamb
          CF_SPACE: development
          CF_APP_DOMAIN: latest.science.loggr.cf-app.com
          CF_SYSTEM_DOMAIN: latest.science.loggr.cf-app.com
          CF_USERNAME: admin
          DATADOG_API_KEY: {{datadog-loggregator-api-key}}
          DRAIN_VERSION: "2.0"
          DRAIN_TYPE: "https"
          JOB_NAME: "https-teardown"
          VARS_STORE_FILE: gcp/science/latest/deployment-vars.yml
        timeout: 20m
      - task: tcp-drain
        file: loggregator-ci/tasks/cf-syslog-drain-smoke-test-with-vars.yml
        params:
          CF_ORG: cf-lamb
          CF_SPACE: development
          CF_APP_DOMAIN: tcp.latest.science.loggr.cf-app.com
          CF_SYSTEM_DOMAIN: latest.science.loggr.cf-app.com
          CF_USERNAME: admin
          DATADOG_API_KEY: {{datadog-loggregator-api-key}}
          DRAIN_VERSION: "2.0"
          DRAIN_TYPE: "syslog"
          JOB_NAME: "syslog-teardown"
          VARS_STORE_FILE: gcp/science/latest/deployment-vars.yml
        timeout: 20m
      timeout: 20m
      ensure:
        put: pipeline-lock
        params:
          release: pipeline-lock

- name: firehose-reliability
  serial_groups: ["locking"]
  plan:
  - aggregate:
    - get: pipeline-lock
    - put: pipeline-lock
      params:
        claim: "pipeline"
    - get: release-elect
      resource: loggregator-release-elect
      passed: ["setup"]
      params:
        submodules: none
    - get: release-latest
      resource: loggregator-latest
      passed: ["setup"]
      params:
        submodules: none
    - get: loggregator
      resource: loggregator-release-elect
    - get: vars-store
      resource: deployments-loggregator
    - get: loggregator-ci
    - get: 10m
      trigger: true
  - task: get-cf-creds
    config:
    file: loggregator-ci/tasks/get-cf-admin-credentials.yml
    params:
      VARS_STORE_FILE: gcp/science/latest/deployment-vars.yml
  - task: loggregator-latest
    file: loggregator-ci/tasks/science/firehose-reliability-test.yml
    params:
      APP_DOMAIN: "loggregator-firehose-reliability.latest.science.loggr.cf-app.com"
      APP_NAME: "loggregator-firehose-reliability"
      CF_API: "api.latest.science.loggr.cf-app.com"
      DATADOG_API_KEY: {{datadog-loggregator-api-key}}
      ORG: cf-lamb
      SPACE: development
      USERNAME: admin
      CLIENT_ID: {{science-firehose-reliability-client-id}}
      CLIENT_SECRET: {{science-firehose-reliability-client-secret}}
      SKIP_CERT_VERIFY: true
      WORKER_INSTANCE_COUNT: 2
    timeout: 10m
  - task: get-cf-creds
    config:
    file: loggregator-ci/tasks/get-cf-admin-credentials.yml
    params:
      VARS_STORE_FILE: gcp/science/release-elect/deployment-vars.yml
  - task: loggregator-elect
    file: loggregator-ci/tasks/science/firehose-reliability-test.yml
    params:
      APP_DOMAIN: "loggregator-firehose-reliability.release-elect.science.loggr.cf-app.com"
      APP_NAME: "loggregator-firehose-reliability"
      CF_API: "api.release-elect.science.loggr.cf-app.com"
      DATADOG_API_KEY: {{datadog-loggregator-api-key}}
      ORG: cf-lamb
      SPACE: development
      USERNAME: admin
      CLIENT_ID: {{science-firehose-reliability-client-id}}
      CLIENT_SECRET: {{science-firehose-reliability-client-secret}}
      SKIP_CERT_VERIFY: true
      WORKER_INSTANCE_COUNT: 2
    timeout: 10m
  ensure:
    put: pipeline-lock
    params:
      release: pipeline-lock

- name: start-incidents
  serial: true
  serial_groups: ["locking"]
  plan:
    - get: pipeline-lock
    - put: pipeline-lock
      params:
        claim: "pipeline"
    - get: 2h
      trigger: true
    - aggregate:
      - get: vars-store
        resource: deployments-loggregator-with-changes
      - get: release-elect
        resource: loggregator-release-elect
        passed: ["setup"]
      - get: release-latest
        resource: loggregator-latest
        passed: ["setup"]
      - get: loggregator-ci
    - aggregate:
      - task: start-incidents-loggregator-elect
        file: loggregator-ci/tasks/science/schedule-turbulence.yml
        params:
          TURBULENCE_API_URL: https://35.192.156.252:6868 # Public IP for `turbulence_api` job. Found in GCP console.
          VARS_FILE_PATH: "gcp/science/release-elect/deployment-vars.yml"
      - task: start-incidents-loggregator-latest
        file: loggregator-ci/tasks/science/schedule-turbulence.yml
        params:
          TURBULENCE_API_URL: https://104.198.22.171:6868 # Public IP for `turbulence_api` job. Found in GCP console.
          VARS_FILE_PATH: "gcp/science/latest/deployment-vars.yml"
  ensure:
    put: pipeline-lock
    params:
      release: pipeline-lock
  on_failure: *slack-failure-alert
