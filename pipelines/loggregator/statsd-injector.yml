resources:
- name: statsd-injector-release
  type: git
  source:
    uri: git@github.com:cloudfoundry/statsd-injector-release
    branch: master
    private_key: {{cf-loggregator-oauth-bot-key}}
    ignore_paths:
    - .final_builds
    - releases

- name: statsd-injector
  type: git
  source:
    uri: git@github.com:cloudfoundry/statsd-injector
    private_key: {{cf-loggregator-oauth-bot-key}}

- name: cf-release-develop
  type: git
  source:
    uri: https://github.com/cloudfoundry/cf-release
    branch: develop

- name: deployments-loggregator
  type: git
  source: &deployments_loggregator
    uri: git@github.com:cloudfoundry/deployments-loggregator.git
    branch: master
    private_key: {{deployments-loggregator-key}}

jobs:
- name: unit-tests
  serial: true
  public: true
  plan:
  - aggregate:
    - get: statsd-injector-release
    - get: statsd-injector
      trigger: true
  - task: run-units
    config:
      image_resource:
        type: docker-image
        source:
          repository: loggregator/base
      platform: linux
      inputs:
      - name: statsd-injector-release
      - name: statsd-injector
      run:
        path: bash
        args:
        - -c
        - {{statsd_units}}

- name: bump-release-submodule
  serial: true
  plan:
  - aggregate:
    - get: statsd-injector-release
      trigger: false
    - get: statsd-injector
      passed:
      - unit-tests
      trigger: true
  - task: update-submodule
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: loggregator/base
      inputs:
      - name: statsd-injector-release
      - name: statsd-injector
      outputs:
      - name: bumped-statsd-injector-release
      params:
        PARENT: statsd-injector-release
        OUTPUT: bumped-statsd-injector-release
        CHILD: statsd-injector
        CHILD_PATH: src/github.com/cloudfoundry/statsd-injector
      run:
        path: bash
        args:
        - -c
        - {{update_submodule}}
  - task: sync-package-spec
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: loggregator/base
      inputs:
        - name: bumped-statsd-injector-release
      outputs:
        - name: synced-statsd-injector-release
      params:
        RELEASE: bumped-statsd-injector-release
        OUTPUT: synced-statsd-injector-release
      run:
        path: bash
        args:
        - -c
        - {{update_package_specs}}
  - task: commit
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: loggregator/base
      inputs:
        - name: synced-statsd-injector-release
      outputs:
      - name: committed-statsd-injector-release
      params:
        SOURCE: synced-statsd-injector-release
        PATHS: src/github.com/cloudfoundry/statsd-injector
        COMMIT_MESSAGE: "Bump statsd-injector"
        OUTPUT: committed-statsd-injector-release
      run:
        path: bash
        args:
        - -c
        - {{commit}}
  - put: statsd-injector-release
    params:
      repository: committed-statsd-injector-release
      rebase: false

- name: deploy
  serial: true
  public: false
  plan:
  - aggregate:
    - get: statsd-injector-release
      trigger: true
      passed:
      - bump-release-submodule
    - get: deployments-loggregator
      trigger: false
  - task: deploy
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: relintdockerhubpushbot/cf-deployment-concourse-tasks
      inputs:
      - name: statsd-injector-release
      - name: deployments-loggregator
      outputs:
      - name: updated-deployments-loggregator
      run:
        path: bash
        args:
          - -c
          - |
            #!/bin/bash
            set -e

            bbl_dir="$PWD/deployments-loggregator/gcp/coconut-bbl"
            statsd_dir="$PWD/statsd-injector-release"

            pushd deployments-loggregator/gcp/coconut-bbl
              export BOSH_CLIENT=`bbl director-username`
              export BOSH_CLIENT_SECRET=`bbl director-password`
              export BOSH_CA_CERT=`bbl director-ca-cert`
              export BOSH_ENVIRONMENT=`bbl director-address`
            popd

            pushd statsd-injector-release
              bosh create-release
              bosh upload-release --rebase

              bosh -n -d statsd-injector deploy \
                --vars-store "$bbl_dir/statsd-injector-vars.yml" \
                --vars-file "$bbl_dir/deployment-vars.yml" \
                "$statsd_dir/manifests/statsd-injector.yml"
            popd

            set +e
            pushd deployments-loggregator
              git config user.email "cf-loggregator@pivotal.io"
              git config user.name "Loggregator CI"
              git add . --all
              git commit -m "Updated statsd-injector deployment vars

              [ci-skip]"
            popd

            rsync -ac deployments-loggregator/ updated-deployments-loggregator
  - put: deployments-loggregator
    params:
      repository: updated-deployments-loggregator
      rebase: true

- name: diff-cert-generation-scripts
  plan:
  - get: statsd-injector-release
    trigger: true
  - get: cf-release
    resource: cf-release-develop
    trigger: true
  - task: diff
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: loggregator/base
      inputs:
      - name: statsd-injector-release
      - name: cf-release
      run:
        path: bash
        args:
          - -c
          - |
            #!/bin/bash
            set -e
            echo diffing statsd-injector cert generation
            diff --unified statsd-injector-release/scripts/generate-certs \
                           cf-release/scripts/generate-statsd-injector-certs
