resources:
- name: loggregator-ci
  type: git
  source:
    uri: git@github.com:cloudfoundry/loggregator-ci.git
    private_key: {{loggregator-key}}

- name: loggregator-backport
  type: git
  source:
    uri: git@github.com:cloudfoundry/loggregator-release.git
    branch: &backport-branch v101.x
    private_key: {{loggregator-key}}

- name: loggregator-release-backport
  type: git
  source:
    uri: git@github.com:cloudfoundry/loggregator-release.git
    branch: *backport-branch
    private_key: {{loggregator-key}}
    ignore_paths:
    - .final_builds
    - releases

- name: loggregator-github-release-drafts
  type: github-release
  source:
    user: cloudfoundry
    repository: loggregator-release
    access_token: {{access-token}}
    drafts: true

jobs:
- name: loggregator-create-backport-release
  serial: true
  plan:
  - aggregate:
    - get: loggregator-backport
    - get: loggregator-release-backport
    - get: loggregator-ci
  - task: create-backport
    file: loggregator-ci/tasks/loggregator-create-release/task.yml
    input_mapping:
      from-repo: loggregator-backport
    params:
      S3_ACCESS_KEY: {{s3-access-key-id}}
      S3_SECRET_KEY: {{s3-secret-access-key}}
      BLOBSTORE_BUCKET: loggregator-release-blobs
      SSH_KEY: {{loggregator-key}}
      NEW_VERSION: "101.11"
      RELEASE_NAME: "Loggregator"
      FROM_BRANCH: *backport-branch
  - put: loggregator-release-backport
    params:
      repository: create-final-release/loggregator-backport
      rebase: false
  - put: loggregator-github-release-drafts
    params:
      name: github-release/name
      tag: github-release/tag
      body: github-release/body
      globs:
      - github-release/*.tgz

